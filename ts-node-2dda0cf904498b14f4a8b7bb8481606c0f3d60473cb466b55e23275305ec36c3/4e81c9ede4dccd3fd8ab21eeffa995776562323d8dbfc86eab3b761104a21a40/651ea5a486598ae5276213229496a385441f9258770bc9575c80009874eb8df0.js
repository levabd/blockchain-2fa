"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
Object.defineProperty(exports, "__esModule", { value: true });
const common_1 = require("@nestjs/common");
const crc32 = require("crc-32");
const crypto = require("crypto");
const env_1 = require("../../../config/env");
exports.md5 = (contents) => crypto.createHash('md5').update(contents).digest('hex');
const decimalToHexString = (number) => {
    if (number < 0) {
        number = 0xFFFFFFFF + number + 1;
    }
    return number.toString(16).toLowerCase();
};
let ApiKeyCheckerMiddleware = class ApiKeyCheckerMiddleware {
    resolve(...args) {
        return (req, res, next) => {
            console.log('req.headers', req.headers);
            if (!req.headers['api-key']) {
                console.log('ApiKeyCheckerMiddleware@resolve: attempt to execute query with no ip key');
                return res.status(common_1.HttpStatus.UNAUTHORIZED).json({ error: 'Wrong API key' });
            }
            console.log('req.headers[api-key]', req.headers['api-key']);
            const apiKey = req.headers['api-key'];
            const queryData = req.method === 'POST' ? req.body : req.query;
            const phoneNumber = `${queryData.phone_number}` || '';
            console.log('queryData', queryData);
            let strArray = [];
            Object.keys(queryData).forEach((key) => {
                let data = queryData[key];
                if (key === 'phone_umber' && data.charAt(0) === ' ') {
                    data = '+' + data;
                }
                strArray.push(`${key}:${data}`);
            });
            console.log('req.path', req.path);
            console.log('strArray', strArray);
            console.log('EnvConfig.API_KEY', env_1.EnvConfig.API_KEY);
            console.log('phoneNumber', phoneNumber);
            console.log('body', strArray.join(';') + ';');
            const bodySrc = crc32.bstr(strArray.join(';') + ';');
            console.log('bodySrc ', decimalToHexString(bodySrc));
            console.log(`${req.path}::body::${decimalToHexString(bodySrc)}::key::${env_1.EnvConfig.API_KEY}::phone_number::` + phoneNumber);
            const hash = exports.md5(`${req.path}::body::${decimalToHexString(bodySrc)}::key::${env_1.EnvConfig.API_KEY}::phone_number::${phoneNumber}`);
            console.log('hash', hash);
            console.log('отразанная строка', apiKey.substring(0, apiKey.length - 17));
            if (hash !== apiKey.substring(0, apiKey.length - 17)) {
                console.log(`ApiKeyCheckerMiddleware@resolve: attempt to execute query with wrong api key: ${apiKey}`);
                return res.status(common_1.HttpStatus.UNAUTHORIZED).json({ error: 'Wrong API key' });
            }
            next();
        };
    }
};
ApiKeyCheckerMiddleware = __decorate([
    common_1.Middleware()
], ApiKeyCheckerMiddleware);
exports.ApiKeyCheckerMiddleware = ApiKeyCheckerMiddleware;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiL2hvbWUvcGVzaGtvdi9kZXYvcHJvamVjdHMvYmxvY2tjaGFpbi0yZmEtYmFja2VuZC9zcmMvbW9kdWxlcy9hcGkvbWlkZGxld2FyZS9hcGkua2V5LmNoZWNrZXIubWlkZGxld2FyZS50cyIsInNvdXJjZXMiOlsiL2hvbWUvcGVzaGtvdi9kZXYvcHJvamVjdHMvYmxvY2tjaGFpbi0yZmEtYmFja2VuZC9zcmMvbW9kdWxlcy9hcGkvbWlkZGxld2FyZS9hcGkua2V5LmNoZWNrZXIubWlkZGxld2FyZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQUFBLDJDQUF5RjtBQUV6RixnQ0FBZ0M7QUFDaEMsaUNBQWlDO0FBQ2pDLDZDQUE4QztBQUVqQyxRQUFBLEdBQUcsR0FBRyxDQUFDLFFBQWdCLEVBQUUsRUFBRSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUVqRyxNQUFNLGtCQUFrQixHQUFHLENBQUMsTUFBTSxFQUFFLEVBQUU7SUFDbEMsRUFBRSxDQUFDLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDYixNQUFNLEdBQUcsVUFBVSxHQUFHLE1BQU0sR0FBRyxDQUFDLENBQUM7SUFDckMsQ0FBQztJQUVELE1BQU0sQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDO0FBQzdDLENBQUMsQ0FBQTtBQUdELElBQWEsdUJBQXVCLEdBQXBDO0lBQ0ksT0FBTyxDQUFDLEdBQUcsSUFBVztRQUNsQixNQUFNLENBQUMsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxFQUFFO1lBQ3RCLE9BQU8sQ0FBQyxHQUFHLENBQUMsYUFBYSxFQUFFLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUN4QyxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxPQUFP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O1lBQzFFLEVBQUUsQ0FBQyxDQUFDLElBQUksS0FBSyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRSxNQUFNLENBQUMsTUFBTSxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDbkQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpRkFBaUYsTUFBTSxFQUFFLENBQUMsQ0FBQztnQkFDdkcsTUFBTSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsbUJBQVUsQ0FBQyxZQUFZLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBQyxLQUFLLEVBQUUsZUFBZSxFQUFDLENBQUMsQ0FBQztZQUM5RSxDQUFDO1lBQ0QsSUFBSSxFQUFFLENBQUM7UUFDWCxDQUFDLENBQUM7SUFDTixDQUFDO0NBQ0osQ0FBQTtBQTNDWSx1QkFBdUI7SUFEbkMsbUJBQVUsRUFBRTtHQUNBLHVCQUF1QixDQTJDbkM7QUEzQ1ksMERBQXVCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtNaWRkbGV3YXJlLCBOZXN0TWlkZGxld2FyZSwgRXhwcmVzc01pZGRsZXdhcmUsIEh0dHBTdGF0dXN9IGZyb20gJ0BuZXN0anMvY29tbW9uJztcblxuaW1wb3J0ICogYXMgY3JjMzIgZnJvbSAnY3JjLTMyJztcbmltcG9ydCAqIGFzIGNyeXB0byBmcm9tICdjcnlwdG8nO1xuaW1wb3J0IHtFbnZDb25maWd9IGZyb20gJy4uLy4uLy4uL2NvbmZpZy9lbnYnO1xuXG5leHBvcnQgY29uc3QgbWQ1ID0gKGNvbnRlbnRzOiBzdHJpbmcpID0+IGNyeXB0by5jcmVhdGVIYXNoKCdtZDUnKS51cGRhdGUoY29udGVudHMpLmRpZ2VzdCgnaGV4Jyk7XG5cbmNvbnN0IGRlY2ltYWxUb0hleFN0cmluZyA9IChudW1iZXIpID0+IHtcbiAgICBpZiAobnVtYmVyIDwgMCkge1xuICAgICAgICBudW1iZXIgPSAweEZGRkZGRkZGICsgbnVtYmVyICsgMTtcbiAgICB9XG5cbiAgICByZXR1cm4gbnVtYmVyLnRvU3RyaW5nKDE2KS50b0xvd2VyQ2FzZSgpO1xufVxuXG5ATWlkZGxld2FyZSgpXG5leHBvcnQgY2xhc3MgQXBpS2V5Q2hlY2tlck1pZGRsZXdhcmUgaW1wbGVtZW50cyBOZXN0TWlkZGxld2FyZSB7XG4gICAgcmVzb2x2ZSguLi5hcmdzOiBhbnlbXSk6IEV4cHJlc3NNaWRkbGV3YXJlIHtcbiAgICAgICAgcmV0dXJuIChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgICAgICAgICAgY29uc29sZS5sb2coJ3JlcS5oZWFkZXJzJywgcmVxLmhlYWRlcnMpO1xuICAgICAgICAgICAgaWYgKCFyZXEuaGVhZGVyc1snYXBpLWtleSddKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0FwaUtleUNoZWNrZXJNaWRkbGV3YXJlQHJlc29sdmU6IGF0dGVtcHQgdG8gZXhlY3V0ZSBxdWVyeSB3aXRoIG5vIGlwIGtleScpO1xuICAgICAgICAgICAgICAgIHJldHVybiByZXMuc3RhdHVzKEh0dHBTdGF0dXMuVU5BVVRIT1JJWkVEKS5qc29uKHtlcnJvcjogJ1dyb25nIEFQSSBrZXknfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zb2xlLmxvZygncmVxLmhlYWRlcnNbYXBpLWtleV0nLCByZXEuaGVhZGVyc1snYXBpLWtleSddKTtcbiAgICAgICAgICAgIC8vINCT0LXQvdC10YDQsNGG0LjRjyDQutC70Y7Rh9CwIEFQSSDQuiDRgtC10LrRg9GJ0LXQvNGDINC30LDQv9GA0L7RgdGDXG4gICAgICAgICAgICBjb25zdCBhcGlLZXkgPSByZXEuaGVhZGVyc1snYXBpLWtleSddO1xuICAgICAgICAgICAgY29uc3QgcXVlcnlEYXRhID0gcmVxLm1ldGhvZCA9PT0gJ1BPU1QnID8gcmVxLmJvZHkgOiByZXEucXVlcnk7XG4gICAgICAgICAgICBjb25zdCBwaG9uZU51bWJlciA9IGAke3F1ZXJ5RGF0YS5waG9uZV9udW1iZXJ9YCB8fCAnJztcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdxdWVyeURhdGEnLCBxdWVyeURhdGEpO1xuICAgICAgICAgICAgbGV0IHN0ckFycmF5ID0gW107XG4gICAgICAgICAgICBPYmplY3Qua2V5cyhxdWVyeURhdGEpLmZvckVhY2goKGtleSkgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBkYXRhID0gcXVlcnlEYXRhW2tleV07XG4gICAgICAgICAgICAgICAgaWYgKGtleSA9PT0gJ3Bob25lX3VtYmVyJyAmJiBkYXRhLmNoYXJBdCgwKSA9PT0gJyAnKSB7XG4gICAgICAgICAgICAgICAgICAgIGRhdGEgPSAnKycgKyBkYXRhO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBzdHJBcnJheS5wdXNoKGAke2tleX06JHtkYXRhfWApO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAvLyBkZXNjcmlwdGlvbnNVcmxBZGRpdGlvbiA9IGRlc2NyaXB0aW9uc1VybEFkZGl0aW9uLnJlcGxhY2UoJyAnLCAnJTJCJyk7XG5cbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdyZXEucGF0aCcsIHJlcS5wYXRoKTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdzdHJBcnJheScsIHN0ckFycmF5KTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdFbnZDb25maWcuQVBJX0tFWScsIEVudkNvbmZpZy5BUElfS0VZKTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdwaG9uZU51bWJlcicsIHBob25lTnVtYmVyKTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdib2R5Jywgc3RyQXJyYXkuam9pbignOycpICsgJzsnKTtcblxuICAgICAgICAgICAgY29uc3QgYm9keVNyYyA9IGNyYzMyLmJzdHIoc3RyQXJyYXkuam9pbignOycpICsgJzsnKTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdib2R5U3JjICcsIGRlY2ltYWxUb0hleFN0cmluZyhib2R5U3JjKSk7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhgJHtyZXEucGF0aH06OmJvZHk6OiR7IGRlY2ltYWxUb0hleFN0cmluZyhib2R5U3JjKX06OmtleTo6JHtFbnZDb25maWcuQVBJX0tFWX06OnBob25lX251bWJlcjo6YCArIHBob25lTnVtYmVyKTtcbiAgICAgICAgICAgIGNvbnN0IGhhc2ggPSBtZDUoYCR7cmVxLnBhdGh9Ojpib2R5OjokeyBkZWNpbWFsVG9IZXhTdHJpbmcoYm9keVNyYyl9OjprZXk6OiR7RW52Q29uZmlnLkFQSV9LRVl9OjpwaG9uZV9udW1iZXI6OiR7cGhvbmVOdW1iZXJ9YCk7XG4gICAgICAgICAgICBjb25zb2xlLmxvZygnaGFzaCcsIGhhc2gpO1xuICAgICAgICAgICAgY29uc29sZS5sb2coJ9C+0YLRgNCw0LfQsNC90L3QsNGPINGB0YLRgNC+0LrQsCcsIGFwaUtleS5zdWJzdHJpbmcoMCwgYXBpS2V5Lmxlbmd0aCAtIDE3KSk7XG4gICAgICAgICAgICBpZiAoaGFzaCAhPT0gYXBpS2V5LnN1YnN0cmluZygwLCBhcGlLZXkubGVuZ3RoIC0gMTcpKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coYEFwaUtleUNoZWNrZXJNaWRkbGV3YXJlQHJlc29sdmU6IGF0dGVtcHQgdG8gZXhlY3V0ZSBxdWVyeSB3aXRoIHdyb25nIGFwaSBrZXk6ICR7YXBpS2V5fWApO1xuICAgICAgICAgICAgICAgIHJldHVybiByZXMuc3RhdHVzKEh0dHBTdGF0dXMuVU5BVVRIT1JJWkVEKS5qc29uKHtlcnJvcjogJ1dyb25nIEFQSSBrZXknfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBuZXh0KCk7XG4gICAgICAgIH07XG4gICAgfVxufSJdfQ==