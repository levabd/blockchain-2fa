"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const env_1 = require("../../../config/env");
const WebSocket = require("ws");
const changeCase = require("change-case");
const helpers_1 = require("../../../services/helpers/helpers");
const redis = require("redis");
const Promisefy = require("bluebird");
const constants_1 = require("../../../config/constants");
const DICT = {
    ru: {
        not_verified: 'Пользователь не прошёл верификацию в мобильном приложении',
        telegram_bot_unregistered: 'Пользователь не зарегистрировался у боте телеграмма @BlockchainTfaBot',
        error_decode_user_bc: 'Ошибка при получении пользователя из блокчейна',
        unknown_error: 'Неизвестная ошибка'
    },
    en: {
        not_verified: 'User is not verified',
        telegram_bot_unregistered: 'User select telegram, but not registered in it yet',
        error_decode_user_bc: 'Cant decode user',
        unknown_error: 'User is not verified'
    },
};
class ApiController {
    constructor(tfaTF, kaztelTF, egovTF) {
        this.tfaTF = tfaTF;
        this.kaztelTF = kaztelTF;
        this.egovTF = egovTF;
        Promisefy.promisifyAll(redis);
        const redisURL = `redis://${env_1.EnvConfig.REDIS_HOST}:${env_1.EnvConfig.REDIS_PORT}`;
        this.redisClient = redis.createClient({ url: redisURL });
    }
    transformLog(log, service) {
        const fieldsToHandle = Object.keys(log);
        let obj = {};
        for (let f of fieldsToHandle) {
            if (f == 'Status' || f == 'ExpiredAt' || f == 'Method' || f == 'ActionTime') {
                continue;
            }
            obj[changeCase.snakeCase(f)] = log[f];
        }
        obj['service'] = service;
        return obj;
    }
    getLatestCode(user) {
        let sendCodeArrayKeysSorted = [];
        const userKeys = Object.keys(user.Logs);
        if (userKeys.length === 0) {
            return { status: 'no_send_codes' };
        }
        const currentTimestamp = (new Date()).getTime() / 1000;
        const keysLength = userKeys.length - 1;
        let sendCodeArrayKeys = [];
        let validCodeArrayKeys = [];
        for (let i = 0; i <= userKeys.length; i++) {
            const log = user.Logs[userKeys[i]];
            if (!log.Status) {
                continue;
            }
            if (log.Status === constants_1.SEND_CODE || log.Status === constants_1.RESEND_CODE) {
                if (currentTimestamp <= log.ExpiredAt && log.Method === 'push') {
                    sendCodeArrayKeys.push(parseInt(userKeys[i], 10));
                }
            }
            if (log.Status === constants_1.VALID || log.Status === constants_1.REJECT) {
                validCodeArrayKeys.push(parseInt(userKeys[i], 10));
            }
            if (i !== keysLength) {
                continue;
            }
            if (sendCodeArrayKeys.length === 0) {
                return { status: 'no_send_codes' };
            }
            sendCodeArrayKeysSorted = sendCodeArrayKeys.sort(helpers_1.sortNumber);
            const latestCodeIndex = sendCodeArrayKeysSorted.length === 1
                ? sendCodeArrayKeysSorted[0]
                : sendCodeArrayKeysSorted[sendCodeArrayKeysSorted.length - 1];
            const latestLog = user.Logs[latestCodeIndex];
            if (!validCodeArrayKeys.length) {
                return { status: 'success', log: latestLog };
            }
            const validKeysLength = validCodeArrayKeys.length - 1;
            for (let j = 0; j < validCodeArrayKeys.length; j++) {
                const logValid = user.Logs[validCodeArrayKeys[j]];
                if (logValid.Code === latestLog.Code) {
                    return { status: 'no_code_used' };
                }
                if (j === validKeysLength) {
                    return { status: 'success', log: latestLog };
                }
            }
        }
    }
    getMessage(lang, locale = 'unknown_error') {
        let _lang = lang;
        if (!DICT[_lang]) {
            _lang = 'en';
        }
        return DICT[_lang][locale] || DICT[_lang]['unknown_error'];
    }
    getUserNotFoundMessage(lang) {
        return lang === 'ru' ? 'Пользователь не найден' : 'User not found';
    }
    openWsConnection(addresses) {
        let ws = new WebSocket(`ws:${env_1.EnvConfig.VALIDATOR_REST_API_USER}:${env_1.EnvConfig.VALIDATOR_REST_API_PASS}@${env_1.EnvConfig.VALIDATOR_REST_API}/subscriptions`);
        ws.onopen = () => {
            ws.send(JSON.stringify({
                'action': 'subscribe',
                'address_prefixes': addresses
            }));
        };
        ws.onclose = () => {
            try {
                ws.send(JSON.stringify({
                    'action': 'unsubscribe'
                }));
            }
            catch (e) {
                console.log('e', e);
            }
        };
        console.log('return', 'return');
        return ws;
    }
    getUser(phoneNumber, service) {
        return __awaiter(this, void 0, void 0, function* () {
            if (!phoneNumber) {
                return null;
            }
            if (phoneNumber.charAt(0) === '+') {
                phoneNumber = phoneNumber.substring(1);
            }
            phoneNumber = phoneNumber.substr(phoneNumber.length - 10);
            const phoneNumberSeven = `7${phoneNumber}`;
            const phoneNumberEight = `8${phoneNumber}`;
            let user = null;
            try {
                user = yield this._getUser(phoneNumberSeven, service);
                return user;
            }
            catch (e) {
                console.log(`Cant find user with phone number: ${phoneNumberSeven}. Trying to find with number: ${phoneNumberEight}`);
                try {
                    user = yield this._getUser(phoneNumberEight, service);
                    return user;
                }
                catch (e) {
                    console.log(`Cant find user with phone number: ${phoneNumberEight}. Return null`);
                    return null;
                }
            }
        });
    }
    _getUser(phoneNumber, service) {
        return __awaiter(this, void 0, void 0, function* () {
            let user;
            try {
                switch (service) {
                    case 'kaztel':
                        user = yield this.kaztelTF.getUser(phoneNumber);
                        break;
                    case 'egov':
                        user = yield this.egovTF.getUser(phoneNumber);
                        break;
                    default:
                        user = yield this.tfaTF.getStateByPhoneNumber(phoneNumber);
                        break;
                }
                if (user.PhoneNumber == '') {
                    return null;
                }
            }
            catch (e) {
                return null;
            }
            return user;
        });
    }
}
exports.ApiController = ApiController;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiL2hvbWUvcGVzaGtvdi9kZXYvcHJvamVjdHMvYmxvY2tjaGFpbi0yZmEtYmFja2VuZC9zcmMvbW9kdWxlcy9hcGkvY29udHJvbGxzZXJzL2NvbnRyb2xsZXIudHMiLCJzb3VyY2VzIjpbIi9ob21lL3Blc2hrb3YvZGV2L3Byb2plY3RzL2Jsb2NrY2hhaW4tMmZhLWJhY2tlbmQvc3JjL21vZHVsZXMvYXBpL2NvbnRyb2xsc2Vycy9jb250cm9sbGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7QUFJQSw2Q0FBOEM7QUFDOUMsZ0NBQWdDO0FBQ2hDLDBDQUEwQztBQUMxQywrREFBNkQ7QUFDN0QsK0JBQStCO0FBQy9CLHNDQUFzQztBQUN0Qyx5REFBZ0Y7QUFFaEYsTUFBTSxJQUFJLEdBQUc7SUFDVCxFQUFFLEVBQUU7UUFDQSxZQUFZLEVBQUUsMkRBQTJEO1FBQ3pFLHlCQUF5QixFQUFFLHVFQUF1RTtRQUNsRyxvQkFBb0IsRUFBRSxnREFBZ0Q7UUFDdEUsYUFBYSxFQUFFLG9CQUFvQjtLQUN0QztJQUNELEVBQUUsRUFBRTtRQUNBLFlBQVksRUFBRSxzQkFBc0I7UUFDcEMseUJBQXlCLEVBQUUsb0RBQW9EO1FBQy9FLG9CQUFvQixFQUFFLGtCQUFrQjtRQUN4QyxhQUFhLEVBQUUsc0JBQXNCO0tBQ3hDO0NBQ0osQ0FBQztBQUVGO0lBRUksWUFBbUIsS0FBMkIsRUFDM0IsUUFBaUMsRUFDakMsTUFBNkI7UUFGN0IsVUFBSyxHQUFMLEtBQUssQ0FBc0I7UUFDM0IsYUFBUSxHQUFSLFFBQVEsQ0FBeUI7UUFDakMsV0FBTSxHQUFOLE1BQU0sQ0FBdUI7UUFDNUMsU0FBUyxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUM5QixNQUFNLFFBQVEsR0FBRyxXQUFXLGVBQVMsQ0FBQyxVQUFVLElBQUksZUFBUyxDQUFDLFVBQVUsRUFBRSxDQUFDO1FBQzNFLElBQUksQ0FBQyxXQUFXLEdBQUcsS0FBSyxDQUFDLFlBQVksQ0FBQyxFQUFDLEdB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QUksQ0FBQztRQUNoQixDQUFDO0tBQUE7Q0FDSjtBQXRNRCxzQ0FzTUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1Bvc3RDbGllbnRVc2VyRFRPfSBmcm9tICcuLi8uLi9zaGFyZWQvbW9kZWxzL2R0by9wb3N0LmthenRlbC51c2VyLmR0byc7XG5pbXBvcnQge0thenRlbFRyYW5zYWN0aW9uRmFtaWx5fSBmcm9tICcuLi8uLi9zaGFyZWQvZmFtaWxpZXMva2F6dGVsLnRyYW5zYWN0aW9uLmZhbWlseSc7XG5pbXBvcnQge1RmYVRyYW5zYWN0aW9uRmFtaWx5fSBmcm9tICcuLi8uLi9zaGFyZWQvZmFtaWxpZXMvdGZhLnRyYW5zYWN0aW9uLmZhbWlseSc7XG5pbXBvcnQge0Vnb3ZUcmFuc2FjdGlvbkZhbWlseX0gZnJvbSAnLi4vLi4vc2hhcmVkL2ZhbWlsaWVzL2Vnb3YudHJhbnNhY3Rpb24uZmFtaWx5JztcbmltcG9ydCB7RW52Q29uZmlnfSBmcm9tICcuLi8uLi8uLi9jb25maWcvZW52JztcbmltcG9ydCAqIGFzIFdlYlNvY2tldCBmcm9tICd3cyc7XG5pbXBvcnQgKiBhcyBjaGFuZ2VDYXNlIGZyb20gJ2NoYW5nZS1jYXNlJztcbmltcG9ydCB7c29ydE51bWJlcn0gZnJvbSAnLi4vLi4vLi4vc2VydmljZXMvaGVscGVycy9oZWxwZXJzJztcbmltcG9ydCAqIGFzIHJlZGlzIGZyb20gJ3JlZGlzJztcbmltcG9ydCAqIGFzIFByb21pc2VmeSBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQge1JFSkVDVCwgUkVTRU5EX0NPREUsIFNFTkRfQ09ERSwgVkFMSUR9IGZyb20gJy4uLy4uLy4uL2NvbmZpZy9jb25zdGFudHMnO1xuXG5jb25zdCBESUNUID0ge1xuICAgIHJ1OiB7XG4gICAgICAgIG5vdF92ZXJpZmllZDogJ9Cf0L7Qu9GM0LfQvtCy0LDRgtC10LvRjCDQvdC1INC/0YDQvtGI0ZHQuyDQstC10YDQuNGE0LjQutCw0YbQuNGOINCyINC80L7QsdC40LvRjNC90L7QvCDQv9GA0LjQu9C+0LbQtdC90LjQuCcsXG4gICAgICAgIHRlbGVncmFtX2JvdF91bnJlZ2lzdGVyZWQ6ICfQn9C+0LvRjNC30L7QstCw0YLQtdC70Ywg0L3QtSDQt9Cw0YDQtdCz0LjRgdGC0YDQuNGA0L7QstCw0LvRgdGPINGDINCx0L7RgtC1INGC0LXQu9C10LPRgNCw0LzQvNCwIEBCbG9ja2NoYWluVGZhQm90JyxcbiAgICAgICAgZXJyb3JfZGVjb2RlX3VzZXJfYmM6ICfQntGI0LjQsdC60LAg0L/RgNC4INC/0L7Qu9GD0YfQtdC90LjQuCDQv9C+0LvRjNC30L7QstCw0YLQtdC70Y8g0LjQtyDQsdC70L7QutGH0LXQudC90LAnLFxuICAgICAgICB1bmtub3duX2Vycm9yOiAn0J3QtdC40LfQstC10YHRgtC90LDRjyDQvtGI0LjQsdC60LAnXG4gICAgfSxcbiAgICBlbjoge1xuICAgICAgICBub3RfdmVyaWZpZWQ6ICdVc2VyIGlzIG5vdCB2ZXJpZmllZCcsXG4gICAgICAgIHRlbGVncmFtX2JvdF91bnJlZ2lzdGVyZWQ6ICdVc2VyIHNlbGVjdCB0ZWxlZ3JhbSwgYnV0IG5vdCByZWdpc3RlcmVkIGluIGl0IHlldCcsXG4gICAgICAgIGVycm9yX2RlY29kZV91c2VyX2JjOiAnQ2FudCBkZWNvZGUgdXNlcicsXG4gICAgICAgIHVua25vd25fZXJyb3I6ICdVc2VyIGlzIG5vdCB2ZXJpZmllZCdcbiAgICB9LFxufTtcblxuZXhwb3J0IGNsYXNzIEFwaUNvbnRyb2xsZXIge1xuICAgIHJlZGlzQ2xpZW50OiBhbnk7XG4gICAgY29uc3RydWN0b3IocHVibGljIHRmYVRGOiBUZmFUcmFuc2FjdGlvbkZhbWlseSxcbiAgICAgICAgICAgICAgICBwdWJsaWMga2F6dGVsVEY6IEthenRlbFRyYW5zYWN0aW9uRmFtaWx5LFxuICAgICAgICAgICAgICAgIHB1YmxpYyBlZ292VEY6IEVnb3ZUcmFuc2FjdGlvbkZhbWlseSwpIHtcbiAgICAgICAgUHJvbWlzZWZ5LnByb21pc2lmeUFsbChyZWRpcyk7XG4gICAgICAgIGNvbnN0IHJlZGlzVVJMID0gYHJlZGlzOi8vJHtFbnZDb25maWcuUkVESVNfSE9TVH06JHtFbnZDb25maWcuUkVESVNfUE9SVH1gO1xuICAgICAgICB0aGlzLnJlZGlzQ2xpZW50ID0gcmVkaXMuY3JlYXRlQ2xpZW50KHt1cmw6IHJlZGlzVVJMfSk7XG4gICAgfVxuXG4gICAgdHJhbnNmb3JtTG9nKGxvZzogYW55LCBzZXJ2aWNlOiBzdHJpbmcpOiBvYmplY3Qge1xuICAgICAgICBjb25zdCBmaWVsZHNUb0hhbmRsZSA9IE9iamVjdC5rZXlzKGxvZyk7XG4gICAgICAgIGxldCBvYmogPSB7fTtcbiAgICAgICAgZm9yIChsZXQgZiBvZiBmaWVsZHNUb0hhbmRsZSkge1xuICAgICAgICAgICAgaWYgKGYgPT0gJ1N0YXR1cycgfHwgZiA9PSAnRXhwaXJlZEF0JyB8fCBmID09ICdNZXRob2QnIHx8IGYgPT0gJ0FjdGlvblRpbWUnKSB7XG4gICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBvYmpbY2hhbmdlQ2FzZS5zbmFrZUNhc2UoZildID0gbG9nW2ZdO1xuICAgICAgICB9XG4gICAgICAgIG9ialsnc2VydmljZSddID0gc2VydmljZTtcbiAgICAgICAgcmV0dXJuIG9iajtcbiAgICB9XG5cbiAgICBnZXRMYXRlc3RDb2RlKHVzZXI6IGFueSk6IGFueSB7XG5cbiAgICAgICAgbGV0IHNlbmRDb2RlQXJyYXlLZXlzU29ydGVkID0gW107XG4gICAgICAgIGNvbnN0IHVzZXJLZXlzID0gT2JqZWN0LmtleXModXNlci5Mb2dzKTtcblxuICAgICAgICBpZiAodXNlcktleXMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICByZXR1cm4ge3N0YXR1czogJ25vX3NlbmRfY29kZXMnfTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGN1cnJlbnRUaW1lc3RhbXAgPSAobmV3IERhdGUoKSkuZ2V0VGltZSgpIC8gMTAwMDtcbiAgICAgICAgY29uc3Qga2V5c0xlbmd0aCA9IHVzZXJLZXlzLmxlbmd0aCAtIDE7XG4gICAgICAgIGxldCBzZW5kQ29kZUFycmF5S2V5cyA9IFtdO1xuICAgICAgICBsZXQgdmFsaWRDb2RlQXJyYXlLZXlzID0gW107XG5cbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPD0gdXNlcktleXMubGVuZ3RoOyBpKyspIHtcblxuICAgICAgICAgICAgY29uc3QgbG9nID0gdXNlci5Mb2dzW3VzZXJLZXlzW2ldXTtcblxuICAgICAgICAgICAgaWYgKCFsb2cuU3RhdHVzKSB7XG4gICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChsb2cuU3RhdHVzID09PSBTRU5EX0NPREUgfHwgbG9nLlN0YXR1cyA9PT0gUkVTRU5EX0NPREUpIHtcbiAgICAgICAgICAgICAgICBpZiAoY3VycmVudFRpbWVzdGFtcCA8PSBsb2cuRXhwaXJlZEF0ICYmIGxvZy5NZXRob2QgPT09ICdwdXNoJykge1xuICAgICAgICAgICAgICAgICAgICBzZW5kQ29kZUFycmF5S2V5cy5wdXNoKHBhcnNlSW50KHVzZXJLZXlzW2ldLCAxMCkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChsb2cuU3RhdHVzID09PSBWQUxJRHx8bG9nLlN0YXR1cyA9PT0gUkVKRUNUKSB7XG4gICAgICAgICAgICAgICAgdmFsaWRDb2RlQXJyYXlLZXlzLnB1c2gocGFyc2VJbnQodXNlcktleXNbaV0sIDEwKSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChpICE9PSBrZXlzTGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChzZW5kQ29kZUFycmF5S2V5cy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICByZXR1cm4ge3N0YXR1czogJ25vX3NlbmRfY29kZXMnfTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgc2VuZENvZGVBcnJheUtleXNTb3J0ZWQgPSBzZW5kQ29kZUFycmF5S2V5cy5zb3J0KHNvcnROdW1iZXIpO1xuXG4gICAgICAgICAgICBjb25zdCBsYXRlc3RDb2RlSW5kZXggPSBzZW5kQ29kZUFycmF5S2V5c1NvcnRlZC5sZW5ndGggPT09IDFcbiAgICAgICAgICAgICAgICA/IHNlbmRDb2RlQXJyYXlLZXlzU29ydGVkWzBdXG4gICAgICAgICAgICAgICAgOiBzZW5kQ29kZUFycmF5S2V5c1NvcnRlZFtzZW5kQ29kZUFycmF5S2V5c1NvcnRlZC5sZW5ndGggLSAxXTtcblxuICAgICAgICAgICAgY29uc3QgbGF0ZXN0TG9nID0gdXNlci5Mb2dzW2xhdGVzdENvZGVJbmRleF07XG5cbiAgICAgICAgICAgIGlmICghdmFsaWRDb2RlQXJyYXlLZXlzLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgIHJldHVybiB7c3RhdHVzOiAnc3VjY2VzcycsIGxvZzogbGF0ZXN0TG9nfTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3QgdmFsaWRLZXlzTGVuZ3RoID0gdmFsaWRDb2RlQXJyYXlLZXlzLmxlbmd0aCAtIDE7XG5cbiAgICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgdmFsaWRDb2RlQXJyYXlLZXlzLmxlbmd0aDsgaisrKSB7XG5cbiAgICAgICAgICAgICAgICBjb25zdCBsb2dWYWxpZCA9IHVzZXIuTG9nc1t2YWxpZENvZGVBcnJheUtleXNbal1dO1xuXG4gICAgICAgICAgICAgICAgaWYgKGxvZ1ZhbGlkLkNvZGUgPT09IGxhdGVzdExvZy5Db2RlKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB7c3RhdHVzOiAnbm9fY29kZV91c2VkJ307XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKGogPT09IHZhbGlkS2V5c0xlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4ge3N0YXR1czogJ3N1Y2Nlc3MnLCBsb2c6IGxhdGVzdExvZ307XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgZ2V0TWVzc2FnZShsYW5nOiBzdHJpbmcsIGxvY2FsZSA9ICd1bmtub3duX2Vycm9yJyk6IHN0cmluZyB7XG4gICAgICAgIGxldCBfbGFuZyA9IGxhbmc7XG4gICAgICAgIGlmICghRElDVFtfbGFuZ10pIHtcbiAgICAgICAgICAgIF9sYW5nID0gJ2VuJztcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBESUNUW19sYW5nXVtsb2NhbGVdIHx8IERJQ1RbX2xhbmddWyd1bmtub3duX2Vycm9yJ107XG4gICAgfVxuXG4gICAgZ2V0VXNlck5vdEZvdW5kTWVzc2FnZShsYW5nOiBzdHJpbmcpIHtcbiAgICAgICAgcmV0dXJuIGxhbmcgPT09ICdydScgPyAn0J/QvtC70YzQt9C+0LLQsNGC0LXQu9GMINC90LUg0L3QsNC50LTQtdC9JyA6ICdVc2VyIG5vdCBmb3VuZCc7XG4gICAgfVxuXG4gICAgb3BlbldzQ29ubmVjdGlvbihhZGRyZXNzZXM6IHN0cmluZ1tdKTogYW55IHtcbiAgICAgICAgbGV0IHdzID0gbmV3IFdlYlNvY2tldChgd3M6JHtFbnZDb25maWcuVkFMSURBVE9SX1JFU1RfQVBJX1VTRVJ9OiR7RW52Q29uZmlnLlZBTElEQVRPUl9SRVNUX0FQSV9QQVNTfUAke0VudkNvbmZpZy5WQUxJREFUT1JfUkVTVF9BUEl9L3N1YnNjcmlwdGlvbnNgKTtcbiAgICAgICAgd3Mub25vcGVuID0gKCkgPT4ge1xuICAgICAgICAgICAgd3Muc2VuZChKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgICAgICAgJ2FjdGlvbic6ICdzdWJzY3JpYmUnLFxuICAgICAgICAgICAgICAgICdhZGRyZXNzX3ByZWZpeGVzJzogYWRkcmVzc2VzXG4gICAgICAgICAgICB9KSk7XG4gICAgICAgIH07XG4gICAgICAgIHdzLm9uY2xvc2UgPSAoKSA9PiB7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIHdzLnNlbmQoSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgICAgICAgICAgICAnYWN0aW9uJzogJ3Vuc3Vic2NyaWJlJ1xuICAgICAgICAgICAgICAgIH0pKTtcbiAgICAgICAgICAgIH0gY2F0Y2goZSl7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ2UnLCBlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgY29uc29sZS5sb2coJ3JldHVybicsICdyZXR1cm4nKTtcblxuICAgICAgICByZXR1cm4gd3M7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IHVzZXIgd2l0aCBieSB0cmFuc2FjdGlvbiBmYSxpbHkgbmFtZVxuICAgICAqICB3ZSBuZWVkIHRvIGNoZWNrIDc3MDUwMDAwMDAwXG4gICAgICogICAgICAgICBhbmQgY2hlY2sgODcwNTAwMDAwMDBcbiAgICAgKiBwaG9uZSBudW1iZXIgY2FuIHN0YXJ0IHdpdGggOCBvciA3XG4gICAgICpcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gcGhvbmVOdW1iZXJcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gc2VydmljZVxuICAgICAqIEByZXR1cm5zIHtQcm9taXNlPFBvc3RDbGllbnRVc2VyRFRPIHwgbnVsbD59XG4gICAgICovXG4gICAgYXN5bmMgZ2V0VXNlcihwaG9uZU51bWJlcjogc3RyaW5nLCBzZXJ2aWNlOiBzdHJpbmcpOiBQcm9taXNlPFBvc3RDbGllbnRVc2VyRFRPIHwgbnVsbD4ge1xuICAgICAgICBpZiAoIXBob25lTnVtYmVyKXtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG4gICAgICAgIGlmIChwaG9uZU51bWJlci5jaGFyQXQoMCkgPT09ICcrJykge1xuICAgICAgICAgICAgcGhvbmVOdW1iZXIgPSBwaG9uZU51bWJlci5zdWJzdHJpbmcoMSk7XG4gICAgICAgIH1cbiAgICAgICAgLy8gd2UgbmVlZCB0byBjaGVjayA3NzA1MDAwMDAwMFxuICAgICAgICAvLyAgICAgICAgYW5kIGNoZWNrIDg3MDUwMDAwMDAwXG4gICAgICAgIC8vIHBob25lIG51bWJlciBjYW4gc3RhcnQgd2l0aCA4IG9yIDdcbiAgICAgICAgcGhvbmVOdW1iZXIgPSBwaG9uZU51bWJlci5zdWJzdHIocGhvbmVOdW1iZXIubGVuZ3RoIC0gMTApO1xuXG4gICAgICAgIC8vIGZpcnN0IGNoZWNrIHdpdGggN1xuICAgICAgICBjb25zdCBwaG9uZU51bWJlclNldmVuID0gYDcke3Bob25lTnVtYmVyfWA7XG4gICAgICAgIGNvbnN0IHBob25lTnVtYmVyRWlnaHQgPSBgOCR7cGhvbmVOdW1iZXJ9YDtcbiAgICAgICAgbGV0IHVzZXIgPSBudWxsO1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgdXNlciA9IGF3YWl0IHRoaXMuX2dldFVzZXIocGhvbmVOdW1iZXJTZXZlbiwgc2VydmljZSk7XG4gICAgICAgICAgICByZXR1cm4gdXNlcjtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgY29uc29sZS5sb2coYENhbnQgZmluZCB1c2VyIHdpdGggcGhvbmUgbnVtYmVyOiAke3Bob25lTnVtYmVyU2V2ZW59LiBUcnlpbmcgdG8gZmluZCB3aXRoIG51bWJlcjogJHtwaG9uZU51bWJlckVpZ2h0fWApO1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICB1c2VyID0gYXdhaXQgdGhpcy5fZ2V0VXNlcihwaG9uZU51bWJlckVpZ2h0LCBzZXJ2aWNlKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gdXNlcjtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgQ2FudCBmaW5kIHVzZXIgd2l0aCBwaG9uZSBudW1iZXI6ICR7cGhvbmVOdW1iZXJFaWdodH0uIFJldHVybiBudWxsYCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQgdXNlciBieSBwaG9uZSBudW1iZXIgYW5kIHRyYW5zYWN0aW9uIGZhbWlseSBuYW1lXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gcGhvbmVOdW1iZXJcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gc2VydmljZVxuICAgICAqIEByZXR1cm5zIHtQcm9taXNlPFBvc3RDbGllbnRVc2VyRFRPIHwgbnVsbD59XG4gICAgICogQHByaXZhdGVcbiAgICAgKi9cbiAgICBwcml2YXRlIGFzeW5jIF9nZXRVc2VyKHBob25lTnVtYmVyOiBzdHJpbmcsIHNlcnZpY2U6IHN0cmluZyk6IFByb21pc2U8UG9zdENsaWVudFVzZXJEVE8gfCBudWxsPiB7XG4gICAgICAgIGxldCB1c2VyO1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgc3dpdGNoIChzZXJ2aWNlKSB7XG4gICAgICAgICAgICAgICAgY2FzZSAna2F6dGVsJzpcbiAgICAgICAgICAgICAgICAgICAgdXNlciA9IGF3YWl0IHRoaXMua2F6dGVsVEYuZ2V0VXNlcihwaG9uZU51bWJlcik7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIGNhc2UgJ2Vnb3YnOlxuICAgICAgICAgICAgICAgICAgICB1c2VyID0gYXdhaXQgdGhpcy5lZ292VEYuZ2V0VXNlcihwaG9uZU51bWJlcik7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgICAgICAgIHVzZXIgPSBhd2FpdCB0aGlzLnRmYVRGLmdldFN0YXRlQnlQaG9uZU51bWJlcihwaG9uZU51bWJlcik7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHVzZXIuUGhvbmVOdW1iZXIgPT0gJycpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdXNlcjtcbiAgICB9XG59Il19