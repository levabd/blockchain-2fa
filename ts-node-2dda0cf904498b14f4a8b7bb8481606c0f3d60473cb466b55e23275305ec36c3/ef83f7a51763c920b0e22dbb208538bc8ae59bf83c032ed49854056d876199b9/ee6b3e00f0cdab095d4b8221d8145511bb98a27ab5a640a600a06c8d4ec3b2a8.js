"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const env_1 = require("../../../config/env");
const changeCase = require("change-case");
const helpers_1 = require("../../../services/helpers/helpers");
const redis = require("redis");
const Promisefy = require("bluebird");
const constants_1 = require("../../../config/constants");
const WebSocket = require('ws');
const HttpsProxyAgent = require('https-proxy-agent');
const url = require('url');
const DICT = {
    ru: {
        not_verified: 'Пользователь не прошёл верификацию в мобильном приложении',
        telegram_bot_unregistered: 'Пользователь не зарегистрировался у боте телеграмма @BlockchainTfaBot',
        error_decode_user_bc: 'Ошибка при получении пользователя из блокчейна',
        unknown_error: 'Неизвестная ошибка'
    },
    en: {
        not_verified: 'User is not verified',
        telegram_bot_unregistered: 'User select telegram, but not registered in it yet',
        error_decode_user_bc: 'Cant decode user',
        unknown_error: 'User is not verified'
    },
};
class ApiController {
    constructor(tfaTF, kaztelTF, egovTF) {
        this.tfaTF = tfaTF;
        this.kaztelTF = kaztelTF;
        this.egovTF = egovTF;
        Promisefy.promisifyAll(redis);
        const redisURL = `redis://${env_1.EnvConfig.REDIS_HOST}:${env_1.EnvConfig.REDIS_PORT}`;
        this.redisClient = redis.createClient({ url: redisURL });
    }
    transformLog(log, service) {
        const fieldsToHandle = Object.keys(log);
        let obj = {};
        for (let f of fieldsToHandle) {
            if (f == 'Status' || f == 'ExpiredAt' || f == 'Method' || f == 'ActionTime') {
                continue;
            }
            obj[changeCase.snakeCase(f)] = log[f];
        }
        obj['service'] = service;
        return obj;
    }
    getLatestCode(user) {
        let sendCodeArrayKeysSorted = [];
        const userKeys = Object.keys(user.Logs);
        if (userKeys.length === 0) {
            return { status: 'no_send_codes' };
        }
        const currentTimestamp = (new Date()).getTime() / 1000;
        const keysLength = userKeys.length - 1;
        let sendCodeArrayKeys = [];
        let validCodeArrayKeys = [];
        for (let i = 0; i <= userKeys.length; i++) {
            const log = user.Logs[userKeys[i]];
            if (!log.Status) {
                continue;
            }
            if (log.Status === constants_1.SEND_CODE || log.Status === constants_1.RESEND_CODE) {
                if (currentTimestamp <= log.ExpiredAt && log.Method === 'push') {
                    sendCodeArrayKeys.push(parseInt(userKeys[i], 10));
                }
            }
            if (log.Status === constants_1.VALID || log.Status === constants_1.REJECT) {
                validCodeArrayKeys.push(parseInt(userKeys[i], 10));
            }
            if (i !== keysLength) {
                continue;
            }
            if (sendCodeArrayKeys.length === 0) {
                return { status: 'no_send_codes' };
            }
            sendCodeArrayKeysSorted = sendCodeArrayKeys.sort(helpers_1.sortNumber);
            const latestCodeIndex = sendCodeArrayKeysSorted.length === 1
                ? sendCodeArrayKeysSorted[0]
                : sendCodeArrayKeysSorted[sendCodeArrayKeysSorted.length - 1];
            const latestLog = user.Logs[latestCodeIndex];
            if (!validCodeArrayKeys.length) {
                return { status: 'success', log: latestLog };
            }
            const validKeysLength = validCodeArrayKeys.length - 1;
            for (let j = 0; j < validCodeArrayKeys.length; j++) {
                const logValid = user.Logs[validCodeArrayKeys[j]];
                if (logValid.Code === latestLog.Code) {
                    return { status: 'no_code_used' };
                }
                if (j === validKeysLength) {
                    return { status: 'success', log: latestLog };
                }
            }
        }
    }
    getMessage(lang, locale = 'unknown_error') {
        let _lang = lang;
        if (!DICT[_lang]) {
            _lang = 'en';
        }
        return DICT[_lang][locale] || DICT[_lang]['unknown_error'];
    }
    getUserNotFoundMessage(lang) {
        return lang === 'ru' ? 'Пользователь не найден' : 'User not found';
    }
    openWsConnection(addresses) {
        const options = url.parse(env_1.EnvConfig.VALIDATOR_REST_API);
        const agent = new HttpsProxyAgent(options);
        let ws = new WebSocket(`ws:${env_1.EnvConfig.VALIDATOR_REST_API_USER}:${env_1.EnvConfig.VALIDATOR_REST_API_PASS}@${env_1.EnvConfig.VALIDATOR_REST_API}/subscriptions`, { agent: agent });
        ws.onopen = () => {
            console.log('onopen');
            ws.send(JSON.stringify({
                'action': 'subscribe',
                'address_prefixes': addresses
            }));
        };
        ws.onclose = () => {
            try {
                ws.send(JSON.stringify({
                    'action': 'unsubscribe'
                }));
            }
            catch (e) {
                console.log('e', e);
            }
        };
        console.log('return', 'openWsConnection');
        return ws;
    }
    getUser(phoneNumber, service) {
        return __awaiter(this, void 0, void 0, function* () {
            if (!phoneNumber) {
                return null;
            }
            if (phoneNumber.charAt(0) === '+') {
                phoneNumber = phoneNumber.substring(1);
            }
            phoneNumber = phoneNumber.substr(phoneNumber.length - 10);
            const phoneNumberSeven = `7${phoneNumber}`;
            const phoneNumberEight = `8${phoneNumber}`;
            let user = null;
            try {
                user = yield this._getUser(phoneNumberSeven, service);
                return user;
            }
            catch (e) {
                console.log(`Cant find user with phone number: ${phoneNumberSeven}. Trying to find with number: ${phoneNumberEight}`);
                try {
                    user = yield this._getUser(phoneNumberEight, service);
                    return user;
                }
                catch (e) {
                    console.log(`Cant find user with phone number: ${phoneNumberEight}. Return null`);
                    return null;
                }
            }
        });
    }
    _getUser(phoneNumber, service) {
        return __awaiter(this, void 0, void 0, function* () {
            let user;
            try {
                switch (service) {
                    case 'kaztel':
                        user = yield this.kaztelTF.getUser(phoneNumber);
                        break;
                    case 'egov':
                        user = yield this.egovTF.getUser(phoneNumber);
                        break;
                    default:
                        user = yield this.tfaTF.getStateByPhoneNumber(phoneNumber);
                        break;
                }
                if (user.PhoneNumber == '') {
                    return null;
                }
            }
            catch (e) {
                return null;
            }
            return user;
        });
    }
}
exports.ApiController = ApiController;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiL2hvbWUvcGVzaGtvdi9kZXYvcHJvamVjdHMvYmxvY2tjaGFpbi0yZmEtYmFja2VuZC9zcmMvbW9kdWxlcy9hcGkvY29udHJvbGxzZXJzL2NvbnRyb2xsZXIudHMiLCJzb3VyY2VzIjpbIi9ob21lL3Blc2hrb3YvZGV2L3Byb2plY3RzL2Jsb2NrY2hhaW4tMmZhLWJhY2tlbmQvc3JjL21vZHVsZXMvYXBpL2NvbnRyb2xsc2Vycy9jb250cm9sbGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7QUFJQSw2Q0FBOEM7QUFFOUMsMENBQTBDO0FBQzFDLCtEQUE2RDtBQUM3RCwrQkFBK0I7QUFDL0Isc0NBQXNDO0FBQ3RDLHlEQUFnRjtBQUVoRixNQUFNLFNBQVMsR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDaEMsTUFBTSxlQUFlLEdBQUcsT0FBTyxDQUFDLG1CQUFtQixDQUFDLENBQUM7QUFDckQsTUFBTSxHQUFHLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBQzNCLE1BQU0sSUFBSSxHQUFHO0lBQ1QsRUFBRSxFQUFFO1FBQ0EsWUFBWSxFQUFFLDJEQUEyRDtRQUN6RSx5QkFBeUIsRUFBRSx1RUFBdUU7UUFDbEcsb0JBQW9CLEVBQUUsZ0RBQWdEO1FBQ3RFLGFBQWEsRUFBRSxvQkFBb0I7S0FDdEM7SUFDRCxFQUFFLEVBQUU7UUFDQSxZQUFZLEVBQUUsc0JBQXNCO1FBQ3BDLHlCQUF5QixFQUFFLG9EQUFvRDtRQUMvRSxvQkFBb0IsRUFBRSxrQkFBa0I7UUFDeEMsYUFBYSxFQUFFLHNCQUFzQjtLQUN4QztDQUNKLENBQUM7QUFFRjtJQUVJLFlBQW1CLEtBQTJCLEVBQzNCLFFBQWlDLEVBQ2pDLE1BQTZCO1FBRjdCLFVBQUssR0FBTCxLQUFLLENBQXNCO1FBQzNCLGFBQVEsR0FBUixRQUFRLENBQXlCO1FBQ2pDLFdBQU0sR0FBTixNQUFNLENBQXVCO1FBQzVDLFNBQVMsQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDLENB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OUMsS0FBSyxDQUFDO29CQUNWO3dCQUNJLElBQUksR0FBRyxNQUFNLElBQUksQ0FBQyxLQUFLLENBQUMscUJBQXFCLENBQUMsV0FBVyxDQUFDLENBQUM7d0JBQzNELEtBQUssQ0FBQztnQkFDZCxDQUFDO2dCQUNELEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxXQUFXLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztvQkFDekIsTUFBTSxDQUFDLElBQUksQ0FBQztnQkFDaEIsQ0FBQztZQUNMLENBQUM7WUFBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUNULE1BQU0sQ0FBQyxJQUFJLENBQUM7WUFDaEIsQ0FBQztZQUVELE1BQU0sQ0FBQyxJQUFJLENBQUM7UUFDaEIsQ0FBQztLQUFBO0NBQ0o7QUF6TUQsc0NBeU1DIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtQb3N0Q2xpZW50VXNlckRUT30gZnJvbSAnLi4vLi4vc2hhcmVkL21vZGVscy9kdG8vcG9zdC5rYXp0ZWwudXNlci5kdG8nO1xuaW1wb3J0IHtLYXp0ZWxUcmFuc2FjdGlvbkZhbWlseX0gZnJvbSAnLi4vLi4vc2hhcmVkL2ZhbWlsaWVzL2thenRlbC50cmFuc2FjdGlvbi5mYW1pbHknO1xuaW1wb3J0IHtUZmFUcmFuc2FjdGlvbkZhbWlseX0gZnJvbSAnLi4vLi4vc2hhcmVkL2ZhbWlsaWVzL3RmYS50cmFuc2FjdGlvbi5mYW1pbHknO1xuaW1wb3J0IHtFZ292VHJhbnNhY3Rpb25GYW1pbHl9IGZyb20gJy4uLy4uL3NoYXJlZC9mYW1pbGllcy9lZ292LnRyYW5zYWN0aW9uLmZhbWlseSc7XG5pbXBvcnQge0VudkNvbmZpZ30gZnJvbSAnLi4vLi4vLi4vY29uZmlnL2Vudic7XG4vLyBpbXBvcnQgKiBhcyBXZWJTb2NrZXQgZnJvbSAnd3MnO1xuaW1wb3J0ICogYXMgY2hhbmdlQ2FzZSBmcm9tICdjaGFuZ2UtY2FzZSc7XG5pbXBvcnQge3NvcnROdW1iZXJ9IGZyb20gJy4uLy4uLy4uL3NlcnZpY2VzL2hlbHBlcnMvaGVscGVycyc7XG5pbXBvcnQgKiBhcyByZWRpcyBmcm9tICdyZWRpcyc7XG5pbXBvcnQgKiBhcyBQcm9taXNlZnkgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IHtSRUpFQ1QsIFJFU0VORF9DT0RFLCBTRU5EX0NPREUsIFZBTElEfSBmcm9tICcuLi8uLi8uLi9jb25maWcvY29uc3RhbnRzJztcblxuY29uc3QgV2ViU29ja2V0ID0gcmVxdWlyZSgnd3MnKTtcbmNvbnN0IEh0dHBzUHJveHlBZ2VudCA9IHJlcXVpcmUoJ2h0dHBzLXByb3h5LWFnZW50Jyk7XG5jb25zdCB1cmwgPSByZXF1aXJlKCd1cmwnKTtcbmNvbnN0IERJQ1QgPSB7XG4gICAgcnU6IHtcbiAgICAgICAgbm90X3ZlcmlmaWVkOiAn0J/QvtC70YzQt9C+0LLQsNGC0LXQu9GMINC90LUg0L/RgNC+0YjRkdC7INCy0LXRgNC40YTQuNC60LDRhtC40Y4g0LIg0LzQvtCx0LjQu9GM0L3QvtC8INC/0YDQuNC70L7QttC10L3QuNC4JyxcbiAgICAgICAgdGVsZWdyYW1fYm90X3VucmVnaXN0ZXJlZDogJ9Cf0L7Qu9GM0LfQvtCy0LDRgtC10LvRjCDQvdC1INC30LDRgNC10LPQuNGB0YLRgNC40YDQvtCy0LDQu9GB0Y8g0YMg0LHQvtGC0LUg0YLQtdC70LXQs9GA0LDQvNC80LAgQEJsb2NrY2hhaW5UZmFCb3QnLFxuICAgICAgICBlcnJvcl9kZWNvZGVfdXNlcl9iYzogJ9Ce0YjQuNCx0LrQsCDQv9GA0Lgg0L/QvtC70YPRh9C10L3QuNC4INC/0L7Qu9GM0LfQvtCy0LDRgtC10LvRjyDQuNC3INCx0LvQvtC60YfQtdC50L3QsCcsXG4gICAgICAgIHVua25vd25fZXJyb3I6ICfQndC10LjQt9Cy0LXRgdGC0L3QsNGPINC+0YjQuNCx0LrQsCdcbiAgICB9LFxuICAgIGVuOiB7XG4gICAgICAgIG5vdF92ZXJpZmllZDogJ1VzZXIgaXMgbm90IHZlcmlmaWVkJyxcbiAgICAgICAgdGVsZWdyYW1fYm90X3VucmVnaXN0ZXJlZDogJ1VzZXIgc2VsZWN0IHRlbGVncmFtLCBidXQgbm90IHJlZ2lzdGVyZWQgaW4gaXQgeWV0JyxcbiAgICAgICAgZXJyb3JfZGVjb2RlX3VzZXJfYmM6ICdDYW50IGRlY29kZSB1c2VyJyxcbiAgICAgICAgdW5rbm93bl9lcnJvcjogJ1VzZXIgaXMgbm90IHZlcmlmaWVkJ1xuICAgIH0sXG59O1xuXG5leHBvcnQgY2xhc3MgQXBpQ29udHJvbGxlciB7XG4gICAgcmVkaXNDbGllbnQ6IGFueTtcbiAgICBjb25zdHJ1Y3RvcihwdWJsaWMgdGZhVEY6IFRmYVRyYW5zYWN0aW9uRmFtaWx5LFxuICAgICAgICAgICAgICAgIHB1YmxpYyBrYXp0ZWxURjogS2F6dGVsVHJhbnNhY3Rpb25GYW1pbHksXG4gICAgICAgICAgICAgICAgcHVibGljIGVnb3ZURjogRWdvdlRyYW5zYWN0aW9uRmFtaWx5LCkge1xuICAgICAgICBQcm9taXNlZnkucHJvbWlzaWZ5QWxsKHJlZGlzKTtcbiAgICAgICAgY29uc3QgcmVkaXNVUkwgPSBgcmVkaXM6Ly8ke0VudkNvbmZpZy5SRURJU19IT1NUfToke0VudkNvbmZpZy5SRURJU19QT1JUfWA7XG4gICAgICAgIHRoaXMucmVkaXNDbGllbnQgPSByZWRpcy5jcmVhdGVDbGllbnQoe3VybDogcmVkaXNVUkx9KTtcbiAgICB9XG5cbiAgICB0cmFuc2Zvcm1Mb2cobG9nOiBhbnksIHNlcnZpY2U6IHN0cmluZyk6IG9iamVjdCB7XG4gICAgICAgIGNvbnN0IGZpZWxkc1RvSGFuZGxlID0gT2JqZWN0LmtleXMobG9nKTtcbiAgICAgICAgbGV0IG9iaiA9IHt9O1xuICAgICAgICBmb3IgKGxldCBmIG9mIGZpZWxkc1RvSGFuZGxlKSB7XG4gICAgICAgICAgICBpZiAoZiA9PSAnU3RhdHVzJyB8fCBmID09ICdFeHBpcmVkQXQnIHx8IGYgPT0gJ01ldGhvZCcgfHwgZiA9PSAnQWN0aW9uVGltZScpIHtcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIG9ialtjaGFuZ2VDYXNlLnNuYWtlQ2FzZShmKV0gPSBsb2dbZl07XG4gICAgICAgIH1cbiAgICAgICAgb2JqWydzZXJ2aWNlJ10gPSBzZXJ2aWNlO1xuICAgICAgICByZXR1cm4gb2JqO1xuICAgIH1cblxuICAgIGdldExhdGVzdENvZGUodXNlcjogYW55KTogYW55IHtcblxuICAgICAgICBsZXQgc2VuZENvZGVBcnJheUtleXNTb3J0ZWQgPSBbXTtcbiAgICAgICAgY29uc3QgdXNlcktleXMgPSBPYmplY3Qua2V5cyh1c2VyLkxvZ3MpO1xuXG4gICAgICAgIGlmICh1c2VyS2V5cy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIHJldHVybiB7c3RhdHVzOiAnbm9fc2VuZF9jb2Rlcyd9O1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgY3VycmVudFRpbWVzdGFtcCA9IChuZXcgRGF0ZSgpKS5nZXRUaW1lKCkgLyAxMDAwO1xuICAgICAgICBjb25zdCBrZXlzTGVuZ3RoID0gdXNlcktleXMubGVuZ3RoIC0gMTtcbiAgICAgICAgbGV0IHNlbmRDb2RlQXJyYXlLZXlzID0gW107XG4gICAgICAgIGxldCB2YWxpZENvZGVBcnJheUtleXMgPSBbXTtcblxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8PSB1c2VyS2V5cy5sZW5ndGg7IGkrKykge1xuXG4gICAgICAgICAgICBjb25zdCBsb2cgPSB1c2VyLkxvZ3NbdXNlcktleXNbaV1dO1xuXG4gICAgICAgICAgICBpZiAoIWxvZy5TdGF0dXMpIHtcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGxvZy5TdGF0dXMgPT09IFNFTkRfQ09ERSB8fCBsb2cuU3RhdHVzID09PSBSRVNFTkRfQ09ERSkge1xuICAgICAgICAgICAgICAgIGlmIChjdXJyZW50VGltZXN0YW1wIDw9IGxvZy5FeHBpcmVkQXQgJiYgbG9nLk1ldGhvZCA9PT0gJ3B1c2gnKSB7XG4gICAgICAgICAgICAgICAgICAgIHNlbmRDb2RlQXJyYXlLZXlzLnB1c2gocGFyc2VJbnQodXNlcktleXNbaV0sIDEwKSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGxvZy5TdGF0dXMgPT09IFZBTElEfHxsb2cuU3RhdHVzID09PSBSRUpFQ1QpIHtcbiAgICAgICAgICAgICAgICB2YWxpZENvZGVBcnJheUtleXMucHVzaChwYXJzZUludCh1c2VyS2V5c1tpXSwgMTApKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGkgIT09IGtleXNMZW5ndGgpIHtcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHNlbmRDb2RlQXJyYXlLZXlzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgIHJldHVybiB7c3RhdHVzOiAnbm9fc2VuZF9jb2Rlcyd9O1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBzZW5kQ29kZUFycmF5S2V5c1NvcnRlZCA9IHNlbmRDb2RlQXJyYXlLZXlzLnNvcnQoc29ydE51bWJlcik7XG5cbiAgICAgICAgICAgIGNvbnN0IGxhdGVzdENvZGVJbmRleCA9IHNlbmRDb2RlQXJyYXlLZXlzU29ydGVkLmxlbmd0aCA9PT0gMVxuICAgICAgICAgICAgICAgID8gc2VuZENvZGVBcnJheUtleXNTb3J0ZWRbMF1cbiAgICAgICAgICAgICAgICA6IHNlbmRDb2RlQXJyYXlLZXlzU29ydGVkW3NlbmRDb2RlQXJyYXlLZXlzU29ydGVkLmxlbmd0aCAtIDFdO1xuXG4gICAgICAgICAgICBjb25zdCBsYXRlc3RMb2cgPSB1c2VyLkxvZ3NbbGF0ZXN0Q29kZUluZGV4XTtcblxuICAgICAgICAgICAgaWYgKCF2YWxpZENvZGVBcnJheUtleXMubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHtzdGF0dXM6ICdzdWNjZXNzJywgbG9nOiBsYXRlc3RMb2d9O1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb25zdCB2YWxpZEtleXNMZW5ndGggPSB2YWxpZENvZGVBcnJheUtleXMubGVuZ3RoIC0gMTtcblxuICAgICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCB2YWxpZENvZGVBcnJheUtleXMubGVuZ3RoOyBqKyspIHtcblxuICAgICAgICAgICAgICAgIGNvbnN0IGxvZ1ZhbGlkID0gdXNlci5Mb2dzW3ZhbGlkQ29kZUFycmF5S2V5c1tqXV07XG5cbiAgICAgICAgICAgICAgICBpZiAobG9nVmFsaWQuQ29kZSA9PT0gbGF0ZXN0TG9nLkNvZGUpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHtzdGF0dXM6ICdub19jb2RlX3VzZWQnfTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAoaiA9PT0gdmFsaWRLZXlzTGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB7c3RhdHVzOiAnc3VjY2VzcycsIGxvZzogbGF0ZXN0TG9nfTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBnZXRNZXNzYWdlKGxhbmc6IHN0cmluZywgbG9jYWxlID0gJ3Vua25vd25fZXJyb3InKTogc3RyaW5nIHtcbiAgICAgICAgbGV0IF9sYW5nID0gbGFuZztcbiAgICAgICAgaWYgKCFESUNUW19sYW5nXSkge1xuICAgICAgICAgICAgX2xhbmcgPSAnZW4nO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIERJQ1RbX2xhbmddW2xvY2FsZV0gfHwgRElDVFtfbGFuZ11bJ3Vua25vd25fZXJyb3InXTtcbiAgICB9XG5cbiAgICBnZXRVc2VyTm90Rm91bmRNZXNzYWdlKGxhbmc6IHN0cmluZykge1xuICAgICAgICByZXR1cm4gbGFuZyA9PT0gJ3J1JyA/ICfQn9C+0LvRjNC30L7QstCw0YLQtdC70Ywg0L3QtSDQvdCw0LnQtNC10L0nIDogJ1VzZXIgbm90IGZvdW5kJztcbiAgICB9XG5cbiAgICBvcGVuV3NDb25uZWN0aW9uKGFkZHJlc3Nlczogc3RyaW5nW10pOiBhbnkge1xuICAgICAgICBjb25zdCBvcHRpb25zID0gdXJsLnBhcnNlKEVudkNvbmZpZy5WQUxJREFUT1JfUkVTVF9BUEkpO1xuICAgICAgICBjb25zdCBhZ2VudCA9IG5ldyBIdHRwc1Byb3h5QWdlbnQob3B0aW9ucyk7XG4gICAgICAgIGxldCB3cyA9IG5ldyBXZWJTb2NrZXQoYHdzOiR7RW52Q29uZmlnLlZBTElEQVRPUl9SRVNUX0FQSV9VU0VSfToke0VudkNvbmZpZy5WQUxJREFUT1JfUkVTVF9BUElfUEFTU31AJHtFbnZDb25maWcuVkFMSURBVE9SX1JFU1RfQVBJfS9zdWJzY3JpcHRpb25zYCwgeyBhZ2VudDogYWdlbnQgfSk7XG4gICAgICAgIHdzLm9ub3BlbiA9ICgpID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdvbm9wZW4nKTtcbiAgICAgICAgICAgIHdzLnNlbmQoSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgICAgICAgICdhY3Rpb24nOiAnc3Vic2NyaWJlJyxcbiAgICAgICAgICAgICAgICAnYWRkcmVzc19wcmVmaXhlcyc6IGFkZHJlc3Nlc1xuICAgICAgICAgICAgfSkpO1xuICAgICAgICB9O1xuICAgICAgICB3cy5vbmNsb3NlID0gKCkgPT4ge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICB3cy5zZW5kKEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICAgICAgICAgICAgJ2FjdGlvbic6ICd1bnN1YnNjcmliZSdcbiAgICAgICAgICAgICAgICB9KSk7XG4gICAgICAgICAgICB9IGNhdGNoKGUpe1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdlJywgZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIGNvbnNvbGUubG9nKCdyZXR1cm4nLCAnb3BlbldzQ29ubmVjdGlvbicpO1xuXG4gICAgICAgIHJldHVybiB3cztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQgdXNlciB3aXRoIGJ5IHRyYW5zYWN0aW9uIGZhLGlseSBuYW1lXG4gICAgICogIHdlIG5lZWQgdG8gY2hlY2sgNzcwNTAwMDAwMDBcbiAgICAgKiAgICAgICAgIGFuZCBjaGVjayA4NzA1MDAwMDAwMFxuICAgICAqIHBob25lIG51bWJlciBjYW4gc3RhcnQgd2l0aCA4IG9yIDdcbiAgICAgKlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBwaG9uZU51bWJlclxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBzZXJ2aWNlXG4gICAgICogQHJldHVybnMge1Byb21pc2U8UG9zdENsaWVudFVzZXJEVE8gfCBudWxsPn1cbiAgICAgKi9cbiAgICBhc3luYyBnZXRVc2VyKHBob25lTnVtYmVyOiBzdHJpbmcsIHNlcnZpY2U6IHN0cmluZyk6IFByb21pc2U8UG9zdENsaWVudFVzZXJEVE8gfCBudWxsPiB7XG4gICAgICAgIGlmICghcGhvbmVOdW1iZXIpe1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHBob25lTnVtYmVyLmNoYXJBdCgwKSA9PT0gJysnKSB7XG4gICAgICAgICAgICBwaG9uZU51bWJlciA9IHBob25lTnVtYmVyLnN1YnN0cmluZygxKTtcbiAgICAgICAgfVxuICAgICAgICAvLyB3ZSBuZWVkIHRvIGNoZWNrIDc3MDUwMDAwMDAwXG4gICAgICAgIC8vICAgICAgICBhbmQgY2hlY2sgODcwNTAwMDAwMDBcbiAgICAgICAgLy8gcGhvbmUgbnVtYmVyIGNhbiBzdGFydCB3aXRoIDggb3IgN1xuICAgICAgICBwaG9uZU51bWJlciA9IHBob25lTnVtYmVyLnN1YnN0cihwaG9uZU51bWJlci5sZW5ndGggLSAxMCk7XG5cbiAgICAgICAgLy8gZmlyc3QgY2hlY2sgd2l0aCA3XG4gICAgICAgIGNvbnN0IHBob25lTnVtYmVyU2V2ZW4gPSBgNyR7cGhvbmVOdW1iZXJ9YDtcbiAgICAgICAgY29uc3QgcGhvbmVOdW1iZXJFaWdodCA9IGA4JHtwaG9uZU51bWJlcn1gO1xuICAgICAgICBsZXQgdXNlciA9IG51bGw7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICB1c2VyID0gYXdhaXQgdGhpcy5fZ2V0VXNlcihwaG9uZU51bWJlclNldmVuLCBzZXJ2aWNlKTtcbiAgICAgICAgICAgIHJldHVybiB1c2VyO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhgQ2FudCBmaW5kIHVzZXIgd2l0aCBwaG9uZSBudW1iZXI6ICR7cGhvbmVOdW1iZXJTZXZlbn0uIFRyeWluZyB0byBmaW5kIHdpdGggbnVtYmVyOiAke3Bob25lTnVtYmVyRWlnaHR9YCk7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIHVzZXIgPSBhd2FpdCB0aGlzLl9nZXRVc2VyKHBob25lTnVtYmVyRWlnaHQsIHNlcnZpY2UpO1xuICAgICAgICAgICAgICAgIHJldHVybiB1c2VyO1xuICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBDYW50IGZpbmQgdXNlciB3aXRoIHBob25lIG51bWJlcjogJHtwaG9uZU51bWJlckVpZ2h0fS4gUmV0dXJuIG51bGxgKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldCB1c2VyIGJ5IHBob25lIG51bWJlciBhbmQgdHJhbnNhY3Rpb24gZmFtaWx5IG5hbWVcbiAgICAgKlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBwaG9uZU51bWJlclxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBzZXJ2aWNlXG4gICAgICogQHJldHVybnMge1Byb21pc2U8UG9zdENsaWVudFVzZXJEVE8gfCBudWxsPn1cbiAgICAgKiBAcHJpdmF0ZVxuICAgICAqL1xuICAgIHByaXZhdGUgYXN5bmMgX2dldFVzZXIocGhvbmVOdW1iZXI6IHN0cmluZywgc2VydmljZTogc3RyaW5nKTogUHJvbWlzZTxQb3N0Q2xpZW50VXNlckRUTyB8IG51bGw+IHtcbiAgICAgICAgbGV0IHVzZXI7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBzd2l0Y2ggKHNlcnZpY2UpIHtcbiAgICAgICAgICAgICAgICBjYXNlICdrYXp0ZWwnOlxuICAgICAgICAgICAgICAgICAgICB1c2VyID0gYXdhaXQgdGhpcy5rYXp0ZWxURi5nZXRVc2VyKHBob25lTnVtYmVyKTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgY2FzZSAnZWdvdic6XG4gICAgICAgICAgICAgICAgICAgIHVzZXIgPSBhd2FpdCB0aGlzLmVnb3ZURi5nZXRVc2VyKHBob25lTnVtYmVyKTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICAgICAgdXNlciA9IGF3YWl0IHRoaXMudGZhVEYuZ2V0U3RhdGVCeVBob25lTnVtYmVyKHBob25lTnVtYmVyKTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAodXNlci5QaG9uZU51bWJlciA9PSAnJykge1xuICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB1c2VyO1xuICAgIH1cbn0iXX0=