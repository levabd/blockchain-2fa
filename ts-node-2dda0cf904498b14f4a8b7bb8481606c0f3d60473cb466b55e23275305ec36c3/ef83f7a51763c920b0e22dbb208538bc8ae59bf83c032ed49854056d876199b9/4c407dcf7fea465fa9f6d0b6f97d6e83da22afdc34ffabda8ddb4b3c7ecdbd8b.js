"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
Object.defineProperty(exports, "__esModule", { value: true });
const common_1 = require("@nestjs/common");
const { createHash } = require('crypto');
const { protobuf } = require('sawtooth-sdk');
const { createContext, CryptoFactory } = require('sawtooth-sdk/signing');
const request = require("request-promise-native");
const env_1 = require("../../config/env");
const helpers_1 = require("../helpers/helpers");
const fs = require("fs");
const protobufMe = require('protocol-buffers');
const messagesClientService = protobufMe(fs.readFileSync('src/proto/service_client.proto'));
const AVAILABLE_TFS = {
    kaztel: {
        name: env_1.EnvConfig.KAZTEL_FAMILY_NAME,
        version: env_1.EnvConfig.KAZTEL_FAMILY_VERSION,
    },
    egov: {
        name: env_1.EnvConfig.EGOV_FAMILY_NAME,
        version: env_1.EnvConfig.EGOV_FAMILY_VERSION,
    },
    tfa: {
        name: env_1.EnvConfig.TFA_FAMILY_NAME,
        version: env_1.EnvConfig.TFA_FAMILY_VERSION,
    },
};
exports.CODE_CREATE = 0;
exports.CODE_UPDATE = 1;
exports.CODE_GENERATE = 2;
exports.CODE_VERIFY = 3;
let ChainService = class ChainService {
    constructor() {
        this.context = createContext('secp256k1');
        const privateKey = this.context.newRandomPrivateKey();
        this.signer = new CryptoFactory(this.context).newSigner(privateKey);
    }
    initTF(name) {
        this.tf = AVAILABLE_TFS[name]['name'];
        this.tfVersion = AVAILABLE_TFS[name]['version'];
        this.prefix = helpers_1._hash(name).substring(0, 6);
    }
    setPrefix(name) {
        this.prefix = helpers_1._hash(name).substring(0, 6);
    }
    getAddress(phoneNumber, prefix) {
        if (prefix) {
            this.setPrefix(prefix);
        }
        return this.prefix + helpers_1._hash(phoneNumber.toString()).slice(-64);
    }
    updateUser(phoneNumber, user, service = 'tfa') {
        this.initTF(service || 'tfa');
        return this.addTransaction({
            Action: exports.CODE_UPDATE,
            PhoneNumber: phoneNumber,
            PayloadUser: user,
        }, this.getAddress(phoneNumber)).then(response => {
            return JSON.parse(response).data;
        }).catch(error => {
            console.log('invalid response', error);
            throw new Error(error);
        });
    }
    getRandomInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    generateCode(phoneNumber, log, tf) {
        this.initTF(tf || 'kaztel');
        const address = this.getAddress(phoneNumber);
        const payloadData = messagesClientService.SCPayload.encode({
            Action: exports.CODE_GENERATE,
            PhoneNumber: phoneNumber,
            PayloadLog: log,
        });
        return this.addTransaction(payloadData, address).then(response => {
            console.log('generateCode@response', response);
            return JSON.parse(response);
        }).catch(error => {
            console.log('invalid response', error);
            throw new Error(error);
        });
    }
    verify(phoneNumber, log, tf) {
        this.initTF(tf || 'kaztel');
        const address = this.getAddress(phoneNumber);
        const payloadData = messagesClientService.SCPayload.encode({
            Action: exports.CODE_VERIFY,
            PhoneNumber: phoneNumber,
            PayloadLog: log,
        });
        return this.addTransaction(payloadData, address).then(response => {
            return JSON.parse(response);
        }).catch(error => {
            console.log('statusCode ', error.pesponse.statusCode);
            console.log('error ', error);
            throw new Error(error);
        });
    }
    getSignedBatch(transactionList) {
        const batchHeaderBytes = protobuf.BatchHeader.encode({
            signerPublicKey: this.signer.getPublicKey().asHex(),
            transactionIds: transactionList.map((txn) => txn.headerSignature),
        }).finish();
        const signature = this.signer.sign(batchHeaderBytes);
        const batch = protobuf.Batch.create({
            header: batchHeaderBytes,
            headerSignature: signature,
            transactions: transactionList
        });
        return protobuf.BatchList.encode({
            batches: [batch]
        }).finish();
    }
    addTransaction(payloadBytes, address, dependOn = '') {
        const transactionHeaderBytes = protobuf.TransactionHeader.encode({
            familyName: this.tf,
            familyVersion: this.tfVersion,
            inputs: [address],
            outputs: [address],
            signerPublicKey: this.signer.getPublicKey().asHex(),
            batcherPublicKey: this.signer.getPublicKey().asHex(),
            dependencies: [],
            payloadSha512: createHash('sha512').update(payloadBytes).digest('hex')
        }).finish();
        const signature = this.signer.sign(transactionHeaderBytes);
        const transaction = protobuf.Transaction.create({
            header: transactionHeaderBytes,
            headerSignature: signature,
            payload: payloadBytes
        });
        console.log('`${EnvConfig.VALIDATOR_REST_API}/batches`', `${env_1.EnvConfig.VALIDATOR_REST_API}/batches`, {
            user: env_1.EnvConfig.VALIDATOR_REST_API_USER,
            pass: env_1.EnvConfig.VALIDATOR_REST_API_PASS
        });
        const bodyAsBytes = this.getSignedBatch([transaction]);
        return request.post({
            family: 4,
            port: 80,
            auth: {
                user: env_1.EnvConfig.VALIDATOR_REST_API_USER,
                pass: env_1.EnvConfig.VALIDATOR_REST_API_PASS
            },
            url: `${env_1.EnvConfig.VALIDATOR_REST_API}/batches`,
            body: bodyAsBytes,
            headers: { 'Content-Type': 'application/octet-stream' }
        });
    }
};
ChainService = __decorate([
    common_1.Component(),
    __metadata("design:paramtypes", [])
], ChainService);
exports.ChainService = ChainService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiL2hvbWUvcGVzaGtvdi9kZXYvcHJvamVjdHMvYmxvY2tjaGFpbi0yZmEtYmFja2VuZC9zcmMvc2VydmljZXMvc2F3dG9vdGgvY2hhaW4uc2VydmljZS50cyIsInNvdXJjZXMiOlsiL2hvbWUvcGVzaGtvdi9kZXYvcHJvamVjdHMvYmxvY2tjaGFpbi0yZmEtYmFja2VuZC9zcmMvc2VydmljZXMvc2F3dG9vdGgvY2hhaW4uc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBLDJDQUF5QztBQUV6QyxNQUFNLEVBQUMsVUFBVSxFQUFDLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQ3ZDLE1BQU0sRUFBQyxRQUFRLEVBQUMsR0FBRyxPQUFPLENBQUMsY0FBYyxDQUFDLENBQUM7QUFDM0MsTUFBTSxFQUFDLGFBQWEsRUFBRSxhQUFhLEVBQUMsR0FBRyxPQUFPLENBQUMsc0JBQXNCLENBQUMsQ0FBQztBQUN2RSxrREFBa0Q7QUFDbEQsMENBQTJDO0FBQzNDLGdEQUF5QztBQUV6Qyx5QkFBeUI7QUFHekIsTUFBTSxVQUFVLEdBQUcsT0FBTyxDQUFDLGtCQUFrQixDQUFDLENBQUM7QUFDL0MsTUFBTSxxQkFBcUIsR0FBRyxVQUFVLENBQUMsRUFBRSxDQUFDLFlBQVksQ0FBQyxnQ0FBZ0MsQ0FBQyxDQUFDLENBQUM7QUFDNUYsTUFBTSxhQUFhLEdBQUc7SUFDbEIsTUFBTSxFQUFFO1FBQ0osSUFBSSxFQUFFLGVBQVMsQ0FBQyxrQkFBa0I7UUFDbEMsT0FBTyxFQUFFLGVBQVMsQ0FBQyxxQkFBcUI7S0FDM0M7SUFDRCxJQUFJLEVBQUU7UUFDRixJQUFJLEVBQUUsZUFBUyxDQUFDLGdCQUFnQjtRQUNoQyxPQUFPLEVBQUUsZUFBUyxDQUFDLG1CQUFtQjtLQUN6QztJQUNELEdBQUcsRUFBRTtRQUNELElBQUksRUFBRSxlQUFTLENBQUMsZUFBZTtRQUMvQixPQUFPLEVBQUUsZUFBUyxDQUFDLGtCQUFrQjtLQUN4QztDQUNKLENB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QUFJLEVBQUUsZUFBUyxDQUFDLHVCQUF1QjtnQkFDdkMsSUFBSSxFQUFFLGVBQVMsQ0FBQyx1QkFBdUI7YUFDMUM7WUFDRCxHQUFHLEVBQUUsR0FBRyxlQUFTLENBQUMsa0JBQWtCLFVBQVU7WUFDOUMsSUFBSSxFQUFFLFdBQVc7WUFDakIsT0FBTyxFQUFFLEVBQUMsY0FBYyxFQUFFLDBCQUEwQixFQUFDO1NBQ3hELENBQUMsQ0FBQztJQUNQLENBQUM7Q0FDSixDQUFBO0FBaEpxQixZQUFZO0lBRGpDLGtCQUFTLEVBQUU7O0dBQ1UsWUFBWSxDQWdKakM7QUFoSnFCLG9DQUFZIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtDb21wb25lbnR9IGZyb20gJ0BuZXN0anMvY29tbW9uJztcblxuY29uc3Qge2NyZWF0ZUhhc2h9ID0gcmVxdWlyZSgnY3J5cHRvJyk7XG5jb25zdCB7cHJvdG9idWZ9ID0gcmVxdWlyZSgnc2F3dG9vdGgtc2RrJyk7XG5jb25zdCB7Y3JlYXRlQ29udGV4dCwgQ3J5cHRvRmFjdG9yeX0gPSByZXF1aXJlKCdzYXd0b290aC1zZGsvc2lnbmluZycpO1xuaW1wb3J0ICogYXMgcmVxdWVzdCBmcm9tICdyZXF1ZXN0LXByb21pc2UtbmF0aXZlJztcbmltcG9ydCB7RW52Q29uZmlnfSBmcm9tICcuLi8uLi9jb25maWcvZW52JztcbmltcG9ydCB7X2hhc2h9IGZyb20gJy4uL2hlbHBlcnMvaGVscGVycyc7XG5pbXBvcnQge1VzZXJMb2d9IGZyb20gJy4uLy4uL21vZHVsZXMvc2hhcmVkL21vZGVscy91c2VyLmxvZyc7XG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcyc7XG5pbXBvcnQge0JhdGNofSBmcm9tICcuLi8uLi9tb2R1bGVzL3NoYXJlZC9tb2RlbHMvYmF0Y2gnO1xuXG5jb25zdCBwcm90b2J1Zk1lID0gcmVxdWlyZSgncHJvdG9jb2wtYnVmZmVycycpO1xuY29uc3QgbWVzc2FnZXNDbGllbnRTZXJ2aWNlID0gcHJvdG9idWZNZShmcy5yZWFkRmlsZVN5bmMoJ3NyYy9wcm90by9zZXJ2aWNlX2NsaWVudC5wcm90bycpKTtcbmNvbnN0IEFWQUlMQUJMRV9URlMgPSB7XG4gICAga2F6dGVsOiB7XG4gICAgICAgIG5hbWU6IEVudkNvbmZpZy5LQVpURUxfRkFNSUxZX05BTUUsXG4gICAgICAgIHZlcnNpb246IEVudkNvbmZpZy5LQVpURUxfRkFNSUxZX1ZFUlNJT04sXG4gICAgfSxcbiAgICBlZ292OiB7XG4gICAgICAgIG5hbWU6IEVudkNvbmZpZy5FR09WX0ZBTUlMWV9OQU1FLFxuICAgICAgICB2ZXJzaW9uOiBFbnZDb25maWcuRUdPVl9GQU1JTFlfVkVSU0lPTixcbiAgICB9LFxuICAgIHRmYToge1xuICAgICAgICBuYW1lOiBFbnZDb25maWcuVEZBX0ZBTUlMWV9OQU1FLFxuICAgICAgICB2ZXJzaW9uOiBFbnZDb25maWcuVEZBX0ZBTUlMWV9WRVJTSU9OLFxuICAgIH0sXG59O1xuXG5leHBvcnQgY29uc3QgQ09ERV9DUkVBVEUgPSAwO1xuZXhwb3J0IGNvbnN0IENPREVfVVBEQVRFID0gMTtcbmV4cG9ydCBjb25zdCBDT0RFX0dFTkVSQVRFID0gMjtcbmV4cG9ydCBjb25zdCBDT0RFX1ZFUklGWSA9IDM7XG5cbkBDb21wb25lbnQoKVxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIENoYWluU2VydmljZSB7XG5cbiAgICAvLyBUT0RPOiByZWZhY3RvclxuICAgIHByb3RlY3RlZCBzaWduZXI6IGFueTtcbiAgICBwcm90ZWN0ZWQgY29udGV4dDogYW55O1xuICAgIHB1YmxpYyBhYnN0cmFjdCB0Zjogc3RyaW5nO1xuICAgIHB1YmxpYyBhYnN0cmFjdCB0ZlZlcnNpb246IHN0cmluZztcbiAgICBwcm90ZWN0ZWQgYWJzdHJhY3QgcHJlZml4OiBzdHJpbmc7XG5cbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgdGhpcy5jb250ZXh0ID0gY3JlYXRlQ29udGV4dCgnc2VjcDI1NmsxJyk7XG4gICAgICAgIGNvbnN0IHByaXZhdGVLZXkgPSB0aGlzLmNvbnRleHQubmV3UmFuZG9tUHJpdmF0ZUtleSgpO1xuICAgICAgICB0aGlzLnNpZ25lciA9IG5ldyBDcnlwdG9GYWN0b3J5KHRoaXMuY29udGV4dCkubmV3U2lnbmVyKHByaXZhdGVLZXkpO1xuICAgIH1cblxuICAgIGluaXRURihuYW1lOiBzdHJpbmcpIHtcbiAgICAgICAgdGhpcy50ZiA9IEFWQUlMQUJMRV9URlNbbmFtZV1bJ25hbWUnXTtcbiAgICAgICAgdGhpcy50ZlZlcnNpb24gPSBBVkFJTEFCTEVfVEZTW25hbWVdWyd2ZXJzaW9uJ107XG4gICAgICAgIHRoaXMucHJlZml4ID0gX2hhc2gobmFtZSkuc3Vic3RyaW5nKDAsIDYpO1xuICAgIH1cblxuICAgIHNldFByZWZpeChuYW1lOiBzdHJpbmcpIHtcbiAgICAgICAgdGhpcy5wcmVmaXggPSBfaGFzaChuYW1lKS5zdWJzdHJpbmcoMCwgNik7XG4gICAgfVxuXG4gICAgZ2V0QWRkcmVzcyhwaG9uZU51bWJlcjogc3RyaW5nLCBwcmVmaXg/OiBzdHJpbmcpOiBzdHJpbmcge1xuICAgICAgICBpZiAocHJlZml4KSB7XG4gICAgICAgICAgICB0aGlzLnNldFByZWZpeChwcmVmaXgpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLnByZWZpeCArIF9oYXNoKHBob25lTnVtYmVyLnRvU3RyaW5nKCkpLnNsaWNlKC02NCk7XG4gICAgfVxuXG4gICAgdXBkYXRlVXNlcihwaG9uZU51bWJlcjogc3RyaW5nLCB1c2VyOiBvYmplY3QsIHNlcnZpY2UgPSAndGZhJyk6IFByb21pc2U8QmF0Y2g+IHtcbiAgICAgICAgdGhpcy5pbml0VEYoc2VydmljZSB8fCAndGZhJyk7XG4gICAgICAgIHJldHVybiB0aGlzLmFkZFRyYW5zYWN0aW9uKHtcbiAgICAgICAgICAgIEFjdGlvbjogQ09ERV9VUERBVEUsXG4gICAgICAgICAgICBQaG9uZU51bWJlcjogcGhvbmVOdW1iZXIsXG4gICAgICAgICAgICBQYXlsb2FkVXNlcjogdXNlcixcbiAgICAgICAgfSwgdGhpcy5nZXRBZGRyZXNzKHBob25lTnVtYmVyKSkudGhlbihyZXNwb25zZSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gPEJhdGNoPkpTT04ucGFyc2UocmVzcG9uc2UpLmRhdGE7XG4gICAgICAgIH0pLmNhdGNoKGVycm9yID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdpbnZhbGlkIHJlc3BvbnNlJywgZXJyb3IpO1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGVycm9yKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgZ2V0UmFuZG9tSW50KG1pbiwgbWF4KSB7XG4gICAgICAgIHJldHVybiBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAobWF4IC0gbWluICsgMSkpICsgbWluO1xuICAgIH1cblxuICAgIGdlbmVyYXRlQ29kZShwaG9uZU51bWJlcjogc3RyaW5nLCBsb2c6IFVzZXJMb2csIHRmOiBzdHJpbmcpOiBhbnkge1xuICAgICAgICB0aGlzLmluaXRURih0ZiB8fCAna2F6dGVsJyk7XG4gICAgICAgIGNvbnN0IGFkZHJlc3MgPSB0aGlzLmdldEFkZHJlc3MocGhvbmVOdW1iZXIpO1xuICAgICAgICBjb25zdCBwYXlsb2FkRGF0YSA9IG1lc3NhZ2VzQ2xpZW50U2VydmljZS5TQ1BheWxvYWQuZW5jb2RlKHtcbiAgICAgICAgICAgIEFjdGlvbjogQ09ERV9HRU5FUkFURSxcbiAgICAgICAgICAgIFBob25lTnVtYmVyOiBwaG9uZU51bWJlcixcbiAgICAgICAgICAgIFBheWxvYWRMb2c6IGxvZyxcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiB0aGlzLmFkZFRyYW5zYWN0aW9uKHBheWxvYWREYXRhLCBhZGRyZXNzKS50aGVuKHJlc3BvbnNlID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdnZW5lcmF0ZUNvZGVAcmVzcG9uc2UnLCByZXNwb25zZSk7XG4gICAgICAgICAgICByZXR1cm4gSlNPTi5wYXJzZShyZXNwb25zZSk7XG4gICAgICAgIH0pLmNhdGNoKGVycm9yID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdpbnZhbGlkIHJlc3BvbnNlJywgZXJyb3IpO1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGVycm9yKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgdmVyaWZ5KHBob25lTnVtYmVyOiBzdHJpbmcsIGxvZzogVXNlckxvZywgdGY6IHN0cmluZykge1xuICAgICAgICB0aGlzLmluaXRURih0ZiB8fCAna2F6dGVsJyk7XG4gICAgICAgIGNvbnN0IGFkZHJlc3MgPSB0aGlzLmdldEFkZHJlc3MocGhvbmVOdW1iZXIpO1xuICAgICAgICBjb25zdCBwYXlsb2FkRGF0YSA9IG1lc3NhZ2VzQ2xpZW50U2VydmljZS5TQ1BheWxvYWQuZW5jb2RlKHtcbiAgICAgICAgICAgIEFjdGlvbjogQ09ERV9WRVJJRlksXG4gICAgICAgICAgICBQaG9uZU51bWJlcjogcGhvbmVOdW1iZXIsXG4gICAgICAgICAgICBQYXlsb2FkTG9nOiBsb2csXG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gdGhpcy5hZGRUcmFuc2FjdGlvbihwYXlsb2FkRGF0YSwgYWRkcmVzcykudGhlbihyZXNwb25zZSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gSlNPTi5wYXJzZShyZXNwb25zZSk7XG4gICAgICAgIH0pLmNhdGNoKGVycm9yID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdzdGF0dXNDb2RlICcsIGVycm9yLnBlc3BvbnNlLnN0YXR1c0NvZGUgKTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdlcnJvciAnLCBlcnJvciApO1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGVycm9yKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgZ2V0U2lnbmVkQmF0Y2godHJhbnNhY3Rpb25MaXN0OiBhbnkpOiBhbnkge1xuICAgICAgICBjb25zdCBiYXRjaEhlYWRlckJ5dGVzID0gcHJvdG9idWYuQmF0Y2hIZWFkZXIuZW5jb2RlKHtcbiAgICAgICAgICAgIHNpZ25lclB1YmxpY0tleTogdGhpcy5zaWduZXIuZ2V0UHVibGljS2V5KCkuYXNIZXgoKSxcbiAgICAgICAgICAgIHRyYW5zYWN0aW9uSWRzOiB0cmFuc2FjdGlvbkxpc3QubWFwKCh0eG4pID0+IHR4bi5oZWFkZXJTaWduYXR1cmUpLFxuICAgICAgICB9KS5maW5pc2goKTtcblxuICAgICAgICBjb25zdCBzaWduYXR1cmUgPSB0aGlzLnNpZ25lci5zaWduKGJhdGNoSGVhZGVyQnl0ZXMpO1xuICAgICAgICBjb25zdCBiYXRjaCA9IHByb3RvYnVmLkJhdGNoLmNyZWF0ZSh7XG4gICAgICAgICAgICBoZWFkZXI6IGJhdGNoSGVhZGVyQnl0ZXMsXG4gICAgICAgICAgICBoZWFkZXJTaWduYXR1cmU6IHNpZ25hdHVyZSxcbiAgICAgICAgICAgIHRyYW5zYWN0aW9uczogdHJhbnNhY3Rpb25MaXN0XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBwcm90b2J1Zi5CYXRjaExpc3QuZW5jb2RlKHtcbiAgICAgICAgICAgIGJhdGNoZXM6IFtiYXRjaF1cbiAgICAgICAgfSkuZmluaXNoKCk7XG4gICAgfVxuXG4gICAgYWRkVHJhbnNhY3Rpb24ocGF5bG9hZEJ5dGVzOiBvYmplY3QsIGFkZHJlc3M6IHN0cmluZywgZGVwZW5kT24gPSAnJyk6IFByb21pc2U8YW55PiB7XG4gICAgICAgIGNvbnN0IHRyYW5zYWN0aW9uSGVhZGVyQnl0ZXMgPSBwcm90b2J1Zi5UcmFuc2FjdGlvbkhlYWRlci5lbmNvZGUoe1xuICAgICAgICAgICAgZmFtaWx5TmFtZTogdGhpcy50ZixcbiAgICAgICAgICAgIGZhbWlseVZlcnNpb246IHRoaXMudGZWZXJzaW9uLFxuICAgICAgICAgICAgaW5wdXRzOiBbYWRkcmVzc10sXG4gICAgICAgICAgICBvdXRwdXRzOiBbYWRkcmVzc10sXG4gICAgICAgICAgICBzaWduZXJQdWJsaWNLZXk6IHRoaXMuc2lnbmVyLmdldFB1YmxpY0tleSgpLmFzSGV4KCksXG4gICAgICAgICAgICAvLyBJbiB0aGlzIGV4YW1wbGUsIHdlJ3JlIHNpZ25pbmcgdGhlIGJhdGNoIHdpdGggdGhlIHNhbWUgcHJpdmF0ZSBrZXksXG4gICAgICAgICAgICAvLyBidXQgdGhlIGJhdGNoIGNhbiBiZSBzaWduZWQgYnkgYW5vdGhlciBwYXJ0eSwgaW4gd2hpY2ggY2FzZSwgdGhlXG4gICAgICAgICAgICAvLyBwdWJsaWMga2V5IHdpbGwgbmVlZCB0byBiZSBhc3NvY2lhdGVkIHdpdGggdGhhdCBrZXkuXG4gICAgICAgICAgICBiYXRjaGVyUHVibGljS2V5OiB0aGlzLnNpZ25lci5nZXRQdWJsaWNLZXkoKS5hc0hleCgpLFxuICAgICAgICAgICAgLy8gSW4gdGhpcyBleGFtcGxlLCB0aGVyZSBhcmUgbm8gZGVwZW5kZW5jaWVzLiAgVGhpcyBsaXN0IHNob3VsZCBpbmNsdWRlXG4gICAgICAgICAgICAvLyBhbiBwcmV2aW91cyB0cmFuc2FjdGlvbiBoZWFkZXIgc2lnbmF0dXJlcyB0aGF0IG11c3QgYmUgYXBwbGllZCBmb3JcbiAgICAgICAgICAgIC8vIHRoaXMgdHJhbnNhY3Rpb24gdG8gc3VjY2Vzc2Z1bGx5IGNvbW1pdC5cbiAgICAgICAgICAgIC8vIEZvciBleGFtcGxlLFxuICAgICAgICAgICAgZGVwZW5kZW5jaWVzOiBbXSxcbiAgICAgICAgICAgIHBheWxvYWRTaGE1MTI6IGNyZWF0ZUhhc2goJ3NoYTUxMicpLnVwZGF0ZShwYXlsb2FkQnl0ZXMpLmRpZ2VzdCgnaGV4JylcbiAgICAgICAgfSkuZmluaXNoKCk7XG4gICAgICAgIGNvbnN0IHNpZ25hdHVyZSA9IHRoaXMuc2lnbmVyLnNpZ24odHJhbnNhY3Rpb25IZWFkZXJCeXRlcyk7XG5cbiAgICAgICAgY29uc3QgdHJhbnNhY3Rpb24gPSBwcm90b2J1Zi5UcmFuc2FjdGlvbi5jcmVhdGUoe1xuICAgICAgICAgICAgaGVhZGVyOiB0cmFuc2FjdGlvbkhlYWRlckJ5dGVzLFxuICAgICAgICAgICAgaGVhZGVyU2lnbmF0dXJlOiBzaWduYXR1cmUsXG4gICAgICAgICAgICBwYXlsb2FkOiBwYXlsb2FkQnl0ZXNcbiAgICAgICAgfSk7XG4gICAgICAgIGNvbnNvbGUubG9nKCdgJHtFbnZDb25maWcuVkFMSURBVE9SX1JFU1RfQVBJfS9iYXRjaGVzYCcsIGAke0VudkNvbmZpZy5WQUxJREFUT1JfUkVTVF9BUEl9L2JhdGNoZXNgLCB7XG4gICAgICAgICAgICB1c2VyOiBFbnZDb25maWcuVkFMSURBVE9SX1JFU1RfQVBJX1VTRVIsXG4gICAgICAgICAgICBwYXNzOiBFbnZDb25maWcuVkFMSURBVE9SX1JFU1RfQVBJX1BBU1NcbiAgICAgICAgfSk7XG4gICAgICAgIGNvbnN0IGJvZHlBc0J5dGVzID0gdGhpcy5nZXRTaWduZWRCYXRjaChbdHJhbnNhY3Rpb25dKTtcbiAgICAgICAgcmV0dXJuIHJlcXVlc3QucG9zdCh7XG4gICAgICAgICAgICBmYW1pbHk6IDQsXG4gICAgICAgICAgICBwb3J0OiA4MCxcbiAgICAgICAgICAgIGF1dGg6IHtcbiAgICAgICAgICAgICAgICB1c2VyOiBFbnZDb25maWcuVkFMSURBVE9SX1JFU1RfQVBJX1VTRVIsXG4gICAgICAgICAgICAgICAgcGFzczogRW52Q29uZmlnLlZBTElEQVRPUl9SRVNUX0FQSV9QQVNTXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgdXJsOiBgJHtFbnZDb25maWcuVkFMSURBVE9SX1JFU1RfQVBJfS9iYXRjaGVzYCxcbiAgICAgICAgICAgIGJvZHk6IGJvZHlBc0J5dGVzLFxuICAgICAgICAgICAgaGVhZGVyczogeydDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtJ31cbiAgICAgICAgfSk7XG4gICAgfVxufVxuIl19