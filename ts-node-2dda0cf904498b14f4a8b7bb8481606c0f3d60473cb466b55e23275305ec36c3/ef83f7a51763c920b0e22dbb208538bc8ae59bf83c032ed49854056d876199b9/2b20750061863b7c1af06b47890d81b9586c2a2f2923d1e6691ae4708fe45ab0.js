"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const common_1 = require("@nestjs/common");
const { createHash } = require('crypto');
const { protobuf } = require('sawtooth-sdk');
const { createContext, CryptoFactory } = require('sawtooth-sdk/signing');
const request = require("request-promise-native");
const env_1 = require("../../config/env");
const helpers_1 = require("../helpers/helpers");
const fs = require("fs");
const protobufMe = require('protocol-buffers');
const messagesClientService = protobufMe(fs.readFileSync('src/proto/service_client.proto'));
const AVAILABLE_TFS = {
    kaztel: {
        name: env_1.EnvConfig.KAZTEL_FAMILY_NAME,
        version: env_1.EnvConfig.KAZTEL_FAMILY_VERSION,
    },
    egov: {
        name: env_1.EnvConfig.EGOV_FAMILY_NAME,
        version: env_1.EnvConfig.EGOV_FAMILY_VERSION,
    },
    tfa: {
        name: env_1.EnvConfig.TFA_FAMILY_NAME,
        version: env_1.EnvConfig.TFA_FAMILY_VERSION,
    },
};
exports.CODE_CREATE = 0;
exports.CODE_UPDATE = 1;
exports.CODE_GENERATE = 2;
exports.CODE_VERIFY = 3;
let ChainService = class ChainService {
    constructor() {
        this.context = createContext('secp256k1');
        const privateKey = this.context.newRandomPrivateKey();
        this.signer = new CryptoFactory(this.context).newSigner(privateKey);
    }
    initTF(name) {
        this.tf = AVAILABLE_TFS[name]['name'];
        this.tfVersion = AVAILABLE_TFS[name]['version'];
        this.prefix = helpers_1._hash(name).substring(0, 6);
    }
    setPrefix(name) {
        this.prefix = helpers_1._hash(name).substring(0, 6);
    }
    getAddress(phoneNumber, prefix) {
        if (prefix) {
            this.setPrefix(prefix);
        }
        return this.prefix + helpers_1._hash(phoneNumber.toString()).slice(-64);
    }
    updateUser(phoneNumber, user, service = 'tfa') {
        this.initTF(service || 'tfa');
        return this.addTransaction({
            Action: exports.CODE_UPDATE,
            PhoneNumber: phoneNumber,
            PayloadUser: user,
        }, this.getAddress(phoneNumber)).then(response => {
            return JSON.parse(response).data;
        }).catch(error => {
            console.log('invalid response', error);
            throw new Error(error);
        });
    }
    getRandomInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    generateCode(phoneNumber, log, tf) {
        this.initTF(tf || 'kaztel');
        const address = this.getAddress(phoneNumber);
        const payloadData = messagesClientService.SCPayload.encode({
            Action: exports.CODE_GENERATE,
            PhoneNumber: phoneNumber,
            PayloadLog: log,
        });
        return this.addTransaction(payloadData, address).then(response => {
            return JSON.parse(response);
        }).catch(error => {
            console.log('invalid response', error);
            throw new Error(error);
        });
    }
    verify(phoneNumber, log, tf) {
        this.initTF(tf || 'kaztel');
        const address = this.getAddress(phoneNumber);
        const payloadData = messagesClientService.SCPayload.encode({
            Action: exports.CODE_VERIFY,
            PhoneNumber: phoneNumber,
            PayloadLog: log,
        });
        return this.addTransaction(payloadData, address).then(response => {
            return JSON.parse(response);
        }).catch(error => {
            console.log('statusCode ', error.pesponse.statusCode);
            console.log('error ', error);
            throw new Error(error);
        });
    }
    getSignedBatch(transactionList) {
        const batchHeaderBytes = protobuf.BatchHeader.encode({
            signerPublicKey: this.signer.getPublicKey().asHex(),
            transactionIds: transactionList.map((txn) => txn.headerSignature),
        }).finish();
        const signature = this.signer.sign(batchHeaderBytes);
        const batch = protobuf.Batch.create({
            header: batchHeaderBytes,
            headerSignature: signature,
            transactions: transactionList
        });
        return protobuf.BatchList.encode({
            batches: [batch]
        }).finish();
    }
    addTransaction(payloadBytes, address, dependOn = '') {
        return __awaiter(this, void 0, void 0, function* () {
            const transactionHeaderBytes = protobuf.TransactionHeader.encode({
                familyName: this.tf,
                familyVersion: this.tfVersion,
                inputs: [address],
                outputs: [address],
                signerPublicKey: this.signer.getPublicKey().asHex(),
                batcherPublicKey: this.signer.getPublicKey().asHex(),
                dependencies: [],
                payloadSha512: createHash('sha512').update(payloadBytes).digest('hex')
            }).finish();
            const signature = this.signer.sign(transactionHeaderBytes);
            const transaction = protobuf.Transaction.create({
                header: transactionHeaderBytes,
                headerSignature: signature,
                payload: payloadBytes
            });
            const bodyAsBytes = yield this.getSignedBatch([transaction]);
            console.log('`${EnvConfig.VALIDATOR_REST_API}/batches`', `${env_1.EnvConfig.VALIDATOR_REST_API}/batches`, {
                user: env_1.EnvConfig.VALIDATOR_REST_API_USER,
                pass: env_1.EnvConfig.VALIDATOR_REST_API_PASS
            }, bodyAsBytes);
            return request.post({
                auth: {
                    user: env_1.EnvConfig.VALIDATOR_REST_API_USER,
                    pass: env_1.EnvConfig.VALIDATOR_REST_API_PASS,
                    sendImmediately: true
                },
                url: `${env_1.EnvConfig.VALIDATOR_REST_API}/batches`,
                body: bodyAsBytes,
                headers: { 'Content-Type': 'application/octet-stream' }
            });
        });
    }
};
ChainService = __decorate([
    common_1.Component(),
    __metadata("design:paramtypes", [])
], ChainService);
exports.ChainService = ChainService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiL2hvbWUvcGVzaGtvdi9kZXYvcHJvamVjdHMvYmxvY2tjaGFpbi0yZmEtYmFja2VuZC9zcmMvc2VydmljZXMvc2F3dG9vdGgvY2hhaW4uc2VydmljZS50cyIsInNvdXJjZXMiOlsiL2hvbWUvcGVzaGtvdi9kZXYvcHJvamVjdHMvYmxvY2tjaGFpbi0yZmEtYmFja2VuZC9zcmMvc2VydmljZXMvc2F3dG9vdGgvY2hhaW4uc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsMkNBQXlDO0FBRXpDLE1BQU0sRUFBQyxVQUFVLEVBQUMsR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDdkMsTUFBTSxFQUFDLFFBQVEsRUFBQyxHQUFHLE9BQU8sQ0FBQyxjQUFjLENBQUMsQ0FBQztBQUMzQyxNQUFNLEVBQUMsYUFBYSxFQUFFLGFBQWEsRUFBQyxHQUFHLE9BQU8sQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO0FBQ3ZFLGtEQUFrRDtBQUNsRCwwQ0FBMkM7QUFDM0MsZ0RBQXlDO0FBRXpDLHlCQUF5QjtBQUd6QixNQUFNLFVBQVUsR0FBRyxPQUFPLENBQUMsa0JBQWtCLENBQUMsQ0FBQztBQUMvQyxNQUFNLHFCQUFxQixHQUFHLFVBQVUsQ0FBQyxFQUFFLENBQUMsWUFBWSxDQUFDLGdDQUFnQyxDQUFDLENBQUMsQ0FBQztBQUM1RixNQUFNLGFBQWEsR0FBRztJQUNsQixNQUFNLEVBQUU7UUFDSixJQUFJLEVBQUUsZUFBUyxDQUFDLGtCQUFrQjtRQUNsQyxPQUFPLEVBQUUsZUFBUyxDQUFDLHFCQUFxQjtLQUMzQztJQUNELElBQUksRUFBRTtRQUNGLElBQUksRUFBRSxlQUFTLENBQUMsZ0JBQWdCO1FBQ2hDLE9BQU8sRUFBRSxlQUFTLENBQUMsbUJBQW1CO0tBQ3pDO0lBQ0QsR0FBRyxFQUFFO1FBQ0QsSUFBSSxFQUFFLGVBQVMsQ0FBQyxlQUFlO1FBQy9CLE9BQU8sRUFBRSxlQUFTLENBQUMsa0JBQWtCO0tBQ3hD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QkFBdUI7b0JBQ3ZDLGVBQWUsRUFBRSxJQUFJO2lCQUN4QjtnQkFDRCxHQUFHLEVBQUUsR0FBRyxlQUFTLENBQUMsa0JBQWtCLFVBQVU7Z0JBQzlDLElBQUksRUFBRSxXQUFXO2dCQUNqQixPQUFPLEVBQUUsRUFBQyxjQUFjLEVBQUUsMEJBQTBCLEVBQUM7YUFDeEQsQ0FBQyxDQUFDO1FBQ1AsQ0FBQztLQUFBO0NBQ0osQ0FBQTtBQTlJcUIsWUFBWTtJQURqQyxrQkFBUyxFQUFFOztHQUNVLFlBQVksQ0E4SWpDO0FBOUlxQixvQ0FBWSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7Q29tcG9uZW50fSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5cbmNvbnN0IHtjcmVhdGVIYXNofSA9IHJlcXVpcmUoJ2NyeXB0bycpO1xuY29uc3Qge3Byb3RvYnVmfSA9IHJlcXVpcmUoJ3Nhd3Rvb3RoLXNkaycpO1xuY29uc3Qge2NyZWF0ZUNvbnRleHQsIENyeXB0b0ZhY3Rvcnl9ID0gcmVxdWlyZSgnc2F3dG9vdGgtc2RrL3NpZ25pbmcnKTtcbmltcG9ydCAqIGFzIHJlcXVlc3QgZnJvbSAncmVxdWVzdC1wcm9taXNlLW5hdGl2ZSc7XG5pbXBvcnQge0VudkNvbmZpZ30gZnJvbSAnLi4vLi4vY29uZmlnL2Vudic7XG5pbXBvcnQge19oYXNofSBmcm9tICcuLi9oZWxwZXJzL2hlbHBlcnMnO1xuaW1wb3J0IHtVc2VyTG9nfSBmcm9tICcuLi8uLi9tb2R1bGVzL3NoYXJlZC9tb2RlbHMvdXNlci5sb2cnO1xuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnO1xuaW1wb3J0IHtCYXRjaH0gZnJvbSAnLi4vLi4vbW9kdWxlcy9zaGFyZWQvbW9kZWxzL2JhdGNoJztcblxuY29uc3QgcHJvdG9idWZNZSA9IHJlcXVpcmUoJ3Byb3RvY29sLWJ1ZmZlcnMnKTtcbmNvbnN0IG1lc3NhZ2VzQ2xpZW50U2VydmljZSA9IHByb3RvYnVmTWUoZnMucmVhZEZpbGVTeW5jKCdzcmMvcHJvdG8vc2VydmljZV9jbGllbnQucHJvdG8nKSk7XG5jb25zdCBBVkFJTEFCTEVfVEZTID0ge1xuICAgIGthenRlbDoge1xuICAgICAgICBuYW1lOiBFbnZDb25maWcuS0FaVEVMX0ZBTUlMWV9OQU1FLFxuICAgICAgICB2ZXJzaW9uOiBFbnZDb25maWcuS0FaVEVMX0ZBTUlMWV9WRVJTSU9OLFxuICAgIH0sXG4gICAgZWdvdjoge1xuICAgICAgICBuYW1lOiBFbnZDb25maWcuRUdPVl9GQU1JTFlfTkFNRSxcbiAgICAgICAgdmVyc2lvbjogRW52Q29uZmlnLkVHT1ZfRkFNSUxZX1ZFUlNJT04sXG4gICAgfSxcbiAgICB0ZmE6IHtcbiAgICAgICAgbmFtZTogRW52Q29uZmlnLlRGQV9GQU1JTFlfTkFNRSxcbiAgICAgICAgdmVyc2lvbjogRW52Q29uZmlnLlRGQV9GQU1JTFlfVkVSU0lPTixcbiAgICB9LFxufTtcblxuZXhwb3J0IGNvbnN0IENPREVfQ1JFQVRFID0gMDtcbmV4cG9ydCBjb25zdCBDT0RFX1VQREFURSA9IDE7XG5leHBvcnQgY29uc3QgQ09ERV9HRU5FUkFURSA9IDI7XG5leHBvcnQgY29uc3QgQ09ERV9WRVJJRlkgPSAzO1xuXG5AQ29tcG9uZW50KClcbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBDaGFpblNlcnZpY2Uge1xuXG4gICAgLy8gVE9ETzogcmVmYWN0b3JcbiAgICBwcm90ZWN0ZWQgc2lnbmVyOiBhbnk7XG4gICAgcHJvdGVjdGVkIGNvbnRleHQ6IGFueTtcbiAgICBwdWJsaWMgYWJzdHJhY3QgdGY6IHN0cmluZztcbiAgICBwdWJsaWMgYWJzdHJhY3QgdGZWZXJzaW9uOiBzdHJpbmc7XG4gICAgcHJvdGVjdGVkIGFic3RyYWN0IHByZWZpeDogc3RyaW5nO1xuXG4gICAgY29uc3RydWN0b3IoKSB7XG4gICAgICAgIHRoaXMuY29udGV4dCA9IGNyZWF0ZUNvbnRleHQoJ3NlY3AyNTZrMScpO1xuICAgICAgICBjb25zdCBwcml2YXRlS2V5ID0gdGhpcy5jb250ZXh0Lm5ld1JhbmRvbVByaXZhdGVLZXkoKTtcbiAgICAgICAgdGhpcy5zaWduZXIgPSBuZXcgQ3J5cHRvRmFjdG9yeSh0aGlzLmNvbnRleHQpLm5ld1NpZ25lcihwcml2YXRlS2V5KTtcbiAgICB9XG5cbiAgICBpbml0VEYobmFtZTogc3RyaW5nKSB7XG4gICAgICAgIHRoaXMudGYgPSBBVkFJTEFCTEVfVEZTW25hbWVdWyduYW1lJ107XG4gICAgICAgIHRoaXMudGZWZXJzaW9uID0gQVZBSUxBQkxFX1RGU1tuYW1lXVsndmVyc2lvbiddO1xuICAgICAgICB0aGlzLnByZWZpeCA9IF9oYXNoKG5hbWUpLnN1YnN0cmluZygwLCA2KTtcbiAgICB9XG5cbiAgICBzZXRQcmVmaXgobmFtZTogc3RyaW5nKSB7XG4gICAgICAgIHRoaXMucHJlZml4ID0gX2hhc2gobmFtZSkuc3Vic3RyaW5nKDAsIDYpO1xuICAgIH1cblxuICAgIGdldEFkZHJlc3MocGhvbmVOdW1iZXI6IHN0cmluZywgcHJlZml4Pzogc3RyaW5nKTogc3RyaW5nIHtcbiAgICAgICAgaWYgKHByZWZpeCkge1xuICAgICAgICAgICAgdGhpcy5zZXRQcmVmaXgocHJlZml4KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5wcmVmaXggKyBfaGFzaChwaG9uZU51bWJlci50b1N0cmluZygpKS5zbGljZSgtNjQpO1xuICAgIH1cblxuICAgIHVwZGF0ZVVzZXIocGhvbmVOdW1iZXI6IHN0cmluZywgdXNlcjogb2JqZWN0LCBzZXJ2aWNlID0gJ3RmYScpOiBQcm9taXNlPEJhdGNoPiB7XG4gICAgICAgIHRoaXMuaW5pdFRGKHNlcnZpY2UgfHwgJ3RmYScpO1xuICAgICAgICByZXR1cm4gdGhpcy5hZGRUcmFuc2FjdGlvbih7XG4gICAgICAgICAgICBBY3Rpb246IENPREVfVVBEQVRFLFxuICAgICAgICAgICAgUGhvbmVOdW1iZXI6IHBob25lTnVtYmVyLFxuICAgICAgICAgICAgUGF5bG9hZFVzZXI6IHVzZXIsXG4gICAgICAgIH0sIHRoaXMuZ2V0QWRkcmVzcyhwaG9uZU51bWJlcikpLnRoZW4ocmVzcG9uc2UgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIDxCYXRjaD5KU09OLnBhcnNlKHJlc3BvbnNlKS5kYXRhO1xuICAgICAgICB9KS5jYXRjaChlcnJvciA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZygnaW52YWxpZCByZXNwb25zZScsIGVycm9yKTtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihlcnJvcik7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGdldFJhbmRvbUludChtaW4sIG1heCkge1xuICAgICAgICByZXR1cm4gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogKG1heCAtIG1pbiArIDEpKSArIG1pbjtcbiAgICB9XG5cbiAgICBnZW5lcmF0ZUNvZGUocGhvbmVOdW1iZXI6IHN0cmluZywgbG9nOiBVc2VyTG9nLCB0Zjogc3RyaW5nKTogYW55IHtcbiAgICAgICAgdGhpcy5pbml0VEYodGYgfHwgJ2thenRlbCcpO1xuICAgICAgICBjb25zdCBhZGRyZXNzID0gdGhpcy5nZXRBZGRyZXNzKHBob25lTnVtYmVyKTtcbiAgICAgICAgY29uc3QgcGF5bG9hZERhdGEgPSBtZXNzYWdlc0NsaWVudFNlcnZpY2UuU0NQYXlsb2FkLmVuY29kZSh7XG4gICAgICAgICAgICBBY3Rpb246IENPREVfR0VORVJBVEUsXG4gICAgICAgICAgICBQaG9uZU51bWJlcjogcGhvbmVOdW1iZXIsXG4gICAgICAgICAgICBQYXlsb2FkTG9nOiBsb2csXG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gdGhpcy5hZGRUcmFuc2FjdGlvbihwYXlsb2FkRGF0YSwgYWRkcmVzcykudGhlbihyZXNwb25zZSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gSlNPTi5wYXJzZShyZXNwb25zZSk7XG4gICAgICAgIH0pLmNhdGNoKGVycm9yID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdpbnZhbGlkIHJlc3BvbnNlJywgZXJyb3IpO1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGVycm9yKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgdmVyaWZ5KHBob25lTnVtYmVyOiBzdHJpbmcsIGxvZzogVXNlckxvZywgdGY6IHN0cmluZykge1xuICAgICAgICB0aGlzLmluaXRURih0ZiB8fCAna2F6dGVsJyk7XG4gICAgICAgIGNvbnN0IGFkZHJlc3MgPSB0aGlzLmdldEFkZHJlc3MocGhvbmVOdW1iZXIpO1xuICAgICAgICBjb25zdCBwYXlsb2FkRGF0YSA9IG1lc3NhZ2VzQ2xpZW50U2VydmljZS5TQ1BheWxvYWQuZW5jb2RlKHtcbiAgICAgICAgICAgIEFjdGlvbjogQ09ERV9WRVJJRlksXG4gICAgICAgICAgICBQaG9uZU51bWJlcjogcGhvbmVOdW1iZXIsXG4gICAgICAgICAgICBQYXlsb2FkTG9nOiBsb2csXG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gdGhpcy5hZGRUcmFuc2FjdGlvbihwYXlsb2FkRGF0YSwgYWRkcmVzcykudGhlbihyZXNwb25zZSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gSlNPTi5wYXJzZShyZXNwb25zZSk7XG4gICAgICAgIH0pLmNhdGNoKGVycm9yID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdzdGF0dXNDb2RlICcsIGVycm9yLnBlc3BvbnNlLnN0YXR1c0NvZGUgKTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdlcnJvciAnLCBlcnJvciApO1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGVycm9yKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgIGdldFNpZ25lZEJhdGNoKHRyYW5zYWN0aW9uTGlzdDogYW55KTogYW55IHtcbiAgICAgICAgY29uc3QgYmF0Y2hIZWFkZXJCeXRlcyA9IHByb3RvYnVmLkJhdGNoSGVhZGVyLmVuY29kZSh7XG4gICAgICAgICAgICBzaWduZXJQdWJsaWNLZXk6IHRoaXMuc2lnbmVyLmdldFB1YmxpY0tleSgpLmFzSGV4KCksXG4gICAgICAgICAgICB0cmFuc2FjdGlvbklkczogdHJhbnNhY3Rpb25MaXN0Lm1hcCgodHhuKSA9PiB0eG4uaGVhZGVyU2lnbmF0dXJlKSxcbiAgICAgICAgfSkuZmluaXNoKCk7XG5cbiAgICAgICAgY29uc3Qgc2lnbmF0dXJlID0gdGhpcy5zaWduZXIuc2lnbihiYXRjaEhlYWRlckJ5dGVzKTtcbiAgICAgICAgY29uc3QgYmF0Y2ggPSBwcm90b2J1Zi5CYXRjaC5jcmVhdGUoe1xuICAgICAgICAgICAgaGVhZGVyOiBiYXRjaEhlYWRlckJ5dGVzLFxuICAgICAgICAgICAgaGVhZGVyU2lnbmF0dXJlOiBzaWduYXR1cmUsXG4gICAgICAgICAgICB0cmFuc2FjdGlvbnM6IHRyYW5zYWN0aW9uTGlzdFxuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gcHJvdG9idWYuQmF0Y2hMaXN0LmVuY29kZSh7XG4gICAgICAgICAgICBiYXRjaGVzOiBbYmF0Y2hdXG4gICAgICAgIH0pLmZpbmlzaCgpO1xuICAgIH1cblxuICAgIGFzeW5jIGFkZFRyYW5zYWN0aW9uKHBheWxvYWRCeXRlczogb2JqZWN0LCBhZGRyZXNzOiBzdHJpbmcsIGRlcGVuZE9uID0gJycpOiBQcm9taXNlPGFueT4ge1xuICAgICAgICBjb25zdCB0cmFuc2FjdGlvbkhlYWRlckJ5dGVzID0gcHJvdG9idWYuVHJhbnNhY3Rpb25IZWFkZXIuZW5jb2RlKHtcbiAgICAgICAgICAgIGZhbWlseU5hbWU6IHRoaXMudGYsXG4gICAgICAgICAgICBmYW1pbHlWZXJzaW9uOiB0aGlzLnRmVmVyc2lvbixcbiAgICAgICAgICAgIGlucHV0czogW2FkZHJlc3NdLFxuICAgICAgICAgICAgb3V0cHV0czogW2FkZHJlc3NdLFxuICAgICAgICAgICAgc2lnbmVyUHVibGljS2V5OiB0aGlzLnNpZ25lci5nZXRQdWJsaWNLZXkoKS5hc0hleCgpLFxuICAgICAgICAgICAgLy8gSW4gdGhpcyBleGFtcGxlLCB3ZSdyZSBzaWduaW5nIHRoZSBiYXRjaCB3aXRoIHRoZSBzYW1lIHByaXZhdGUga2V5LFxuICAgICAgICAgICAgLy8gYnV0IHRoZSBiYXRjaCBjYW4gYmUgc2lnbmVkIGJ5IGFub3RoZXIgcGFydHksIGluIHdoaWNoIGNhc2UsIHRoZVxuICAgICAgICAgICAgLy8gcHVibGljIGtleSB3aWxsIG5lZWQgdG8gYmUgYXNzb2NpYXRlZCB3aXRoIHRoYXQga2V5LlxuICAgICAgICAgICAgYmF0Y2hlclB1YmxpY0tleTogdGhpcy5zaWduZXIuZ2V0UHVibGljS2V5KCkuYXNIZXgoKSxcbiAgICAgICAgICAgIC8vIEluIHRoaXMgZXhhbXBsZSwgdGhlcmUgYXJlIG5vIGRlcGVuZGVuY2llcy4gIFRoaXMgbGlzdCBzaG91bGQgaW5jbHVkZVxuICAgICAgICAgICAgLy8gYW4gcHJldmlvdXMgdHJhbnNhY3Rpb24gaGVhZGVyIHNpZ25hdHVyZXMgdGhhdCBtdXN0IGJlIGFwcGxpZWQgZm9yXG4gICAgICAgICAgICAvLyB0aGlzIHRyYW5zYWN0aW9uIHRvIHN1Y2Nlc3NmdWxseSBjb21taXQuXG4gICAgICAgICAgICAvLyBGb3IgZXhhbXBsZSxcbiAgICAgICAgICAgIGRlcGVuZGVuY2llczogW10sXG4gICAgICAgICAgICBwYXlsb2FkU2hhNTEyOiBjcmVhdGVIYXNoKCdzaGE1MTInKS51cGRhdGUocGF5bG9hZEJ5dGVzKS5kaWdlc3QoJ2hleCcpXG4gICAgICAgIH0pLmZpbmlzaCgpO1xuICAgICAgICBjb25zdCBzaWduYXR1cmUgPSB0aGlzLnNpZ25lci5zaWduKHRyYW5zYWN0aW9uSGVhZGVyQnl0ZXMpO1xuXG4gICAgICAgIGNvbnN0IHRyYW5zYWN0aW9uID0gcHJvdG9idWYuVHJhbnNhY3Rpb24uY3JlYXRlKHtcbiAgICAgICAgICAgIGhlYWRlcjogdHJhbnNhY3Rpb25IZWFkZXJCeXRlcyxcbiAgICAgICAgICAgIGhlYWRlclNpZ25hdHVyZTogc2lnbmF0dXJlLFxuICAgICAgICAgICAgcGF5bG9hZDogcGF5bG9hZEJ5dGVzXG4gICAgICAgIH0pO1xuICAgICAgICBjb25zdCBib2R5QXNCeXRlcyA9IGF3YWl0IHRoaXMuZ2V0U2lnbmVkQmF0Y2goW3RyYW5zYWN0aW9uXSk7XG4gICAgICAgIGNvbnNvbGUubG9nKCdgJHtFbnZDb25maWcuVkFMSURBVE9SX1JFU1RfQVBJfS9iYXRjaGVzYCcsIGAke0VudkNvbmZpZy5WQUxJREFUT1JfUkVTVF9BUEl9L2JhdGNoZXNgLCB7XG4gICAgICAgICAgICB1c2VyOiBFbnZDb25maWcuVkFMSURBVE9SX1JFU1RfQVBJX1VTRVIsXG4gICAgICAgICAgICBwYXNzOiBFbnZDb25maWcuVkFMSURBVE9SX1JFU1RfQVBJX1BBU1NcbiAgICAgICAgfSwgYm9keUFzQnl0ZXMpO1xuICAgICAgICByZXR1cm4gcmVxdWVzdC5wb3N0KHtcbiAgICAgICAgICAgIGF1dGg6IHtcbiAgICAgICAgICAgICAgICB1c2VyOiBFbnZDb25maWcuVkFMSURBVE9SX1JFU1RfQVBJX1VTRVIsXG4gICAgICAgICAgICAgICAgcGFzczogRW52Q29uZmlnLlZBTElEQVRPUl9SRVNUX0FQSV9QQVNTLFxuICAgICAgICAgICAgICAgIHNlbmRJbW1lZGlhdGVseTogdHJ1ZVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHVybDogYCR7RW52Q29uZmlnLlZBTElEQVRPUl9SRVNUX0FQSX0vYmF0Y2hlc2AsXG4gICAgICAgICAgICBib2R5OiBib2R5QXNCeXRlcyxcbiAgICAgICAgICAgIGhlYWRlcnM6IHsnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL29jdGV0LXN0cmVhbSd9XG4gICAgICAgIH0pO1xuICAgIH1cbn1cbiJdfQ==